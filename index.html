<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>極簡日系旅程 | SnowTravel</title>
    
    <!-- Google Fonts: Noto Sans TC -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class', // 手動模式
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Noto Sans TC', 'sans-serif'],
                    },
                    colors: {
                        navy: {
                            50: '#f0f4f8',
                            100: '#d9e2ec',
                            500: '#334e68',
                            800: '#102a43',
                            900: '#0b1d30',
                        },
                        ice: {
                            100: '#e3f8ff',
                            500: '#40c3f7',
                        }
                    },
                    keyframes: {
                        'pop-in': {
                            '0%': { transform: 'scale(0.9)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' },
                        },
                        'slide-up': {
                            '0%': { transform: 'translateY(100%)' },
                            '100%': { transform: 'translateY(0)' },
                        }
                    },
                    animation: {
                        'pop-in': 'pop-in 0.2s ease-out forwards',
                        'slide-up': 'slide-up 0.3s ease-out forwards',
                    }
                }
            }
        }
    </script>

    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <style>
        /* 隱藏 Scrollbar */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        /* 玻璃/卡片樣式 */
        .glass {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            color: #000000;
        }

        /* 淺海軍藍背景 */
        .bg-light-navy {
            background-color: #eef2f6;
            border-color: #dbe4ee;
        }

        /* 漸變 Banner (調整透明度以配合插畫風格) */
        .banner-gradient {
            background: linear-gradient(135deg, rgba(11, 29, 48, 0.6) 0%, rgba(36, 59, 85, 0.4) 50%, rgba(109, 213, 237, 0.2) 100%);
        }

        body {
            background-color: #ffffff;
        }
        
        .drag-moving {
            opacity: 0.5;
            background: #f3f4f6;
        }
    </style>
</head>
<body class="text-black antialiased selection:bg-ice-500 selection:text-white pb-24 bg-white">

    <div id="app">
        
        <!-- 1. 頁首 Banner -->
        <!-- 已更換為日系鄉村/櫻花風格圖片。若要使用您上傳的檔案，請將 bg-[url(...)] 中的網址改為您的圖檔路徑 (例如 'banner.jpg') -->
        <header class="relative w-full h-[280px] md:h-[350px] flex items-center justify-center overflow-hidden shadow-lg bg-navy-900">
            <div class="absolute top-0 left-0 w-full h-full opacity-80 bg-[url('banner.jpg')] bg-cover bg-center"></div>
            <!-- 疊加一層漸變讓文字更清楚 -->
            <div class="absolute top-0 left-0 w-full h-full banner-gradient"></div>
            
            <div class="relative z-10 text-center text-white px-4">
                <h1 class="text-3xl font-light tracking-[0.2em] mb-2 drop-shadow-md">2026・福岡</h1>
                <p class="text-sm font-light opacity-90 tracking-widest">日本・福岡</p>
            </div>

            <!-- Tab 導航欄 -->
            <div class="absolute bottom-12 right-4 z-50 flex space-x-3 overflow-x-auto p-2 no-scrollbar">
                <button 
                    v-for="tab in tabs" 
                    :key="tab.id"
                    @click="currentTab = tab.id"
                    :class="[
                        'flex flex-col items-center justify-center w-14 h-14 rounded-2xl transition-all duration-300 shadow-lg backdrop-blur-md border border-white/20',
                        currentTab === tab.id 
                            ? 'bg-ice-500 text-white scale-110 shadow-ice-500/50' 
                            : 'bg-white/20 text-white hover:bg-white/30'
                    ]"
                >
                    <i :class="tab.icon + ' text-xl mb-1'"></i>
                    <span class="text-[10px] font-bold">{{ tab.name }}</span>
                </button>
            </div>
        </header>

        <!-- 主內容區域 -->
        <main class="relative -mt-10 bg-white rounded-t-[2.5rem] min-h-screen shadow-[0_-10px_40px_rgba(0,0,0,0.05)] overflow-hidden transition-colors duration-300">
            
            <div class="pt-8 pb-32 px-4 md:px-6 max-w-3xl mx-auto">

                <!-- TAB 1: 每日行程表 -->
                <div v-if="currentTab === 'itinerary'" class="animate-fade-in">
                    
                    <!-- 日期選擇器 -->
                    <div class="flex space-x-4 overflow-x-auto no-scrollbar mb-6 pb-2 items-center pt-2">
                        <div 
                            v-for="(day, index) in tripDates" 
                            :key="index"
                            @click="selectedDateIndex = index"
                            :class="[
                                'relative flex-shrink-0 flex flex-col items-center justify-center w-16 h-20 rounded-2xl cursor-pointer transition-all border group shadow-sm',
                                selectedDateIndex === index 
                                    ? 'bg-navy-800 text-white border-transparent shadow-lg transform scale-105' 
                                    : 'bg-white text-gray-500 border-gray-200 hover:border-gray-400'
                            ]"
                        >
                            <button 
                                @click.stop="triggerConfirm('確定要刪除 ' + day.date + ' 號這天的所有行程嗎？', () => deleteDay(index))" 
                                class="absolute -top-2 -right-2 w-5 h-5 bg-red-500 text-white rounded-full flex items-center justify-center shadow-md z-10 hover:bg-red-600 active:scale-90 transition-transform"
                                v-if="tripDates.length > 1"
                            >
                                <i class="fas fa-times text-[10px]"></i>
                            </button>
                            <span class="text-xs font-medium uppercase">{{ day.week }}</span>
                            <span class="text-2xl font-bold">{{ day.date }}</span>
                        </div>
                        
                        <button @click="addDay" class="flex-shrink-0 flex items-center justify-center w-16 h-20 rounded-2xl cursor-pointer transition-all border bg-gray-50 text-gray-400 border-gray-200 hover:bg-gray-100 active:scale-95 shadow-sm">
                            <i class="fas fa-plus text-xl"></i>
                        </button>
                    </div>

                    <!-- 天氣 Widget (實時 API) -->
                    <div class="bg-gradient-to-r from-blue-400 to-ice-500 text-white rounded-2xl p-4 mb-8 shadow-lg flex items-center justify-between">
                        <div>
                            <div class="text-sm opacity-90 mb-1 flex items-center">
                                <i class="fas fa-location-dot mr-1"></i> 福岡, 日本 
                                <span v-if="weather.isForecast" class="ml-2 text-[10px] bg-white/20 px-1.5 rounded">預報</span>
                                <span v-else class="ml-2 text-[10px] bg-white/20 px-1.5 rounded">即時</span>
                            </div>
                            <div class="text-3xl font-bold">{{ weather.temp }}°C</div>
                            <div class="text-xs opacity-80">體感 {{ weather.feelsLike }}°C</div>
                        </div>
                        <div class="text-center">
                            <i :class="weather.icon + ' text-4xl mb-1'"></i>
                            <div class="text-xs font-bold">{{ weather.status }}</div>
                        </div>
                    </div>

                    <!-- 行程列表 -->
                    <div class="space-y-6 relative">
                        <div v-if="currentDayItinerary.length === 0" class="text-center py-10 text-gray-400">
                            <i class="fas fa-map-signs text-4xl mb-3 opacity-50"></i>
                            <p>點擊右下角 + 新增今日行程</p>
                        </div>

                        <div v-if="currentDayItinerary.length > 0" class="absolute top-6 bottom-6 left-[2.25rem] w-0.5 border-l-2 border-dashed border-gray-200 z-0"></div>

                        <div 
                            v-for="(item, index) in currentDayItinerary" 
                            :key="item.id"
                            draggable="true"
                            @dragstart="dragStart(index)"
                            @dragover.prevent
                            @drop="drop(index)"
                            class="relative z-10 group"
                        >
                            <div v-if="index > 0" class="flex items-center ml-14 mb-2">
                                <div class="bg-gray-100 text-gray-500 text-xs px-3 py-1 rounded-full border border-gray-200 flex items-center">
                                    <i :class="getTransportIcon(item.transportMode) + ' mr-2'"></i>
                                    <span>約 {{ calculateTravelTime(currentDayItinerary[index-1], item) }}</span>
                                </div>
                            </div>
                            <div v-if="index === 0 && item.category !== 'flight'" class="flex items-center ml-14 mb-2">
                                <div class="bg-gray-100 text-gray-500 text-xs px-3 py-1 rounded-full border border-gray-200 flex items-center">
                                    <i class="fas fa-hotel mr-2"></i>
                                    <span>飯店出發</span>
                                    <i class="fas fa-walking mx-2"></i>
                                    <span>約 20 分</span>
                                </div>
                            </div>

                            <div class="flex bg-white rounded-2xl p-4 shadow-sm border border-gray-100 relative overflow-visible"
                            >
                                <div class="flex flex-col items-center mr-4 min-w-[3.5rem] z-10">
                                    <div :class="['w-14 h-14 rounded-full flex items-center justify-center text-white text-xl mb-2 shadow-md', getCategoryColor(item.category)]">
                                        <i :class="getCategoryIcon(item.category)"></i>
                                    </div>
                                    <div class="text-sm font-bold text-gray-800 font-mono">{{ item.startTime || '--:--' }}</div>
                                </div>

                                <div class="flex-1 min-w-0 pt-1">
                                    <h3 class="text-lg font-bold text-gray-900 mb-1 leading-tight">{{ item.name }}</h3>
                                    
                                    <div class="flex items-center text-xs text-gray-500 mb-2 truncate">
                                         <i :class="item.category === 'flight' ? 'fas fa-plane' : 'fas fa-map-marker-alt'" class="mr-1.5 opacity-70"></i> 
                                         <span>{{ item.category === 'flight' ? item.flightCode : item.name }}</span>
                                    </div>

                                    <div class="flex flex-wrap gap-x-3 gap-y-1 text-xs text-gray-500 mb-3">
                                         <span v-if="item.ticketPrice" class="flex items-center text-orange-600 font-medium bg-orange-50 px-1.5 py-0.5 rounded">
                                             <i class="fas fa-ticket-alt mr-1"></i> {{ item.ticketPrice }}
                                         </span>
                                         <span v-if="item.openTime" class="flex items-center">
                                             <i class="far fa-clock mr-1"></i> {{ item.openTime }}
                                         </span>
                                    </div>

                                    <div v-if="item.note" class="bg-gray-50 rounded-lg p-2.5 text-xs text-gray-600 flex items-start border border-gray-100">
                                        <i class="fas fa-pen text-yellow-500 mt-0.5 mr-2"></i>
                                        <span class="leading-relaxed">{{ item.note }}</span>
                                    </div>
                                </div>

                                <div class="flex flex-col justify-between items-center ml-2 pl-2 border-l border-gray-100 space-y-1">
                                    <div class="flex flex-col space-y-1">
                                        <button v-if="index > 0" @click.stop="moveItem(index, -1)" class="w-6 h-6 flex items-center justify-center text-gray-300 hover:text-navy-500 transition-colors"><i class="fas fa-chevron-up text-xs"></i></button>
                                        <div v-else class="h-6"></div>
                                        <button v-if="index < currentDayItinerary.length - 1" @click.stop="moveItem(index, 1)" class="w-6 h-6 flex items-center justify-center text-gray-300 hover:text-navy-500 transition-colors"><i class="fas fa-chevron-down text-xs"></i></button>
                                        <div v-else class="h-6"></div>
                                    </div>
                                    <div class="flex flex-col space-y-2 mt-auto pb-1">
                                        <button @click.stop="openMap(item.name)" class="w-8 h-8 rounded-full bg-ice-100 text-ice-500 hover:bg-ice-500 hover:text-white flex items-center justify-center transition-all shadow-sm"><i class="fas fa-location-arrow text-xs"></i></button>
                                        <button @click.stop="editItem(item)" class="w-8 h-8 flex items-center justify-center text-gray-300 hover:text-blue-500 transition-colors"><i class="fas fa-pen text-xs"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button @click="showAddModal = true; isEditing = false; resetForm()" class="fixed bottom-6 right-6 w-14 h-14 bg-navy-900 text-white rounded-full shadow-2xl flex items-center justify-center text-2xl hover:scale-110 transition-transform z-40 border-2 border-white">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>

                <!-- TAB 2: 資訊 -->
                <div v-if="currentTab === 'info'" class="space-y-6 animate-fade-in">
                    <!-- 匯率換算 -->
                    <section class="bg-light-navy rounded-2xl p-5 shadow-sm border">
                        <h3 class="text-black font-bold mb-4 flex items-center justify-between">
                            <span class="flex items-center"><i class="fas fa-coins mr-2 text-yellow-500"></i> 匯率換算</span>
                            <span class="text-[10px] bg-green-100 text-green-600 px-2 py-1 rounded-full">即時匯率</span>
                        </h3>
                        <div class="flex items-center space-x-2">
                            <div class="flex-1">
                                <label class="text-xs text-gray-500 block mb-1">日幣 (JPY)</label>
                                <input type="number" v-model="currency.jpy" @input="convertCurrency('jpy')" class="w-full bg-white rounded-lg p-2 font-mono text-lg text-black focus:outline-none focus:ring-2 focus:ring-blue-500 border border-gray-200">
                            </div>
                            <i class="fas fa-exchange-alt text-gray-400 mt-5"></i>
                            <div class="flex-1">
                                <label class="text-xs text-gray-500 block mb-1">港幣 (HKD)</label>
                                <input type="number" v-model="currency.hkd" @input="convertCurrency('hkd')" class="w-full bg-white rounded-lg p-2 font-mono text-lg text-black focus:outline-none focus:ring-2 focus:ring-blue-500 border border-gray-200">
                            </div>
                        </div>
                        <p class="text-[10px] text-right text-gray-400 mt-2">1 HKD ≈ {{ currency.rate }} JPY</p>
                    </section>

                    <!-- 航班 -->
                    <section class="space-y-4">
                         <div class="flex items-center justify-between px-1">
                            <h3 class="text-black font-bold flex items-center"><i class="fas fa-plane-departure mr-2 text-blue-500"></i> 航班資訊</h3>
                            <button @click="openInfoModal('flight', 'add')" class="text-xs bg-blue-100 text-blue-600 px-3 py-1.5 rounded-full hover:bg-blue-200 font-bold"><i class="fas fa-plus mr-1"></i> 新增</button>
                        </div>
                        
                        <div v-for="(flight, index) in flights" :key="flight.id" 
                             :class="['rounded-xl p-5 pb-16 relative group border shadow-sm', flight.title === '去程' ? 'bg-blue-50 border-blue-100' : 'bg-indigo-50 border-indigo-100']">
                            
                            <!-- 編輯/刪除按鈕 -->
                             <div class="absolute bottom-1 right-3 flex space-x-2">
                                <button @click="openInfoModal('flight', 'edit', flight)" class="w-8 h-8 rounded-full bg-white/80 text-gray-500 hover:text-blue-500 flex items-center justify-center transition-colors shadow-sm"><i class="fas fa-pen text-xs"></i></button>
                                <button @click="triggerConfirm('確定刪除此航班？', () => deleteInfoData('flight', flight.id))" class="w-8 h-8 rounded-full bg-white/80 text-gray-500 hover:text-red-500 flex items-center justify-center transition-colors shadow-sm"><i class="fas fa-trash text-xs"></i></button>
                            </div>

                            <div class="flex justify-between text-xs font-bold text-gray-500 mb-3">
                                <span class="bg-white/60 px-2 py-1 rounded">{{ flight.title }} {{ flight.date }}</span> 
                                <span class="font-mono text-sm text-navy-800">{{ flight.code }}</span>
                            </div>
                            <div class="flex justify-between items-center text-black px-2">
                                <div><div class="text-3xl font-bold">{{ flight.depCode }}</div><div class="text-xs text-gray-600 font-bold mt-1">{{ flight.depTime }}</div></div>
                                
                                <div class="text-xs text-gray-400 flex flex-col items-center">
                                    <span class="mb-1 text-[10px]">{{ flight.duration }}</span>
                                    <div class="relative w-16 h-8 flex items-center justify-center">
                                        <!-- 
                                            去程: 向右 (rotate 90deg) 
                                            回程: 向左 (rotate -90deg)
                                        -->
                                        <i class="fas fa-plane text-2xl transition-transform" 
                                           :style="{ display: 'inline-block', transform: flight.title === '去程' ? 'rotate(90deg)' : 'rotate(-90deg)' }"
                                           :class="flight.title === '去程' ? 'text-blue-400' : 'text-indigo-400'">
                                        </i>
                                    </div>
                                </div>

                                <div class="text-right"><div class="text-3xl font-bold">{{ flight.arrCode }}</div><div class="text-xs text-gray-600 font-bold mt-1">{{ flight.arrTime }}</div></div>
                            </div>
                        </div>
                    </section>

                    <!-- 住宿 -->
                    <section class="space-y-4">
                        <div class="flex items-center justify-between px-1">
                            <h3 class="text-black font-bold flex items-center"><i class="fas fa-bed mr-2 text-indigo-500"></i> 住宿資訊</h3>
                             <button @click="openInfoModal('hotel', 'add')" class="text-xs bg-indigo-100 text-indigo-600 px-3 py-1.5 rounded-full hover:bg-indigo-200 font-bold"><i class="fas fa-plus mr-1"></i> 新增</button>
                        </div>

                        <div v-for="(h, index) in hotels" :key="h.id" class="glass rounded-xl p-5 border-l-4 border-l-indigo-500 border-t border-r border-b border-gray-200 relative">
                            <div class="absolute bottom-3 right-3 flex space-x-2">
                                <button @click="openInfoModal('hotel', 'edit', h)" class="w-8 h-8 rounded-full bg-gray-100 text-gray-500 hover:text-blue-500 flex items-center justify-center transition-colors"><i class="fas fa-pen text-xs"></i></button>
                                <button @click="triggerConfirm('確定刪除此住宿？', () => deleteInfoData('hotel', h.id))" class="w-8 h-8 rounded-full bg-gray-100 text-gray-500 hover:text-red-500 flex items-center justify-center transition-colors"><i class="fas fa-trash text-xs"></i></button>
                            </div>

                            <h4 class="font-bold text-lg text-black pr-16">{{ h.name }}</h4>
                            <div class="space-y-2 mt-3 mb-6">
                                <p class="text-sm text-gray-600 flex items-start"><i class="fas fa-map-marker-alt mr-2 mt-1 text-indigo-400 w-4 text-center"></i> {{ h.address }}</p>
                                <p class="text-sm text-gray-600 flex items-center"><i class="fas fa-phone mr-2 text-indigo-400 w-4 text-center"></i> {{ h.phone }}</p>
                            </div>
                            <button @click="openMap(h.name + ' ' + h.address)" class="text-xs bg-indigo-50 text-indigo-600 px-3 py-1.5 rounded-full font-bold hover:bg-indigo-100 border border-indigo-100">
                                <i class="fas fa-location-arrow mr-1"></i> 導航前往
                            </button>
                        </div>
                    </section>

                    <!-- 緊急 -->
                    <section class="grid grid-cols-2 gap-4">
                        <div class="bg-red-50 p-4 rounded-2xl text-center cursor-pointer border border-red-100 hover:bg-red-100 transition-colors" @click="callNumber('110')">
                            <i class="fas fa-user-shield text-3xl text-red-500 mb-2"></i>
                            <div class="font-bold text-red-600">警察 110</div>
                        </div>
                        <div class="bg-red-50 p-4 rounded-2xl text-center cursor-pointer border border-red-100 hover:bg-red-100 transition-colors" @click="callNumber('119')">
                            <i class="fas fa-ambulance text-3xl text-red-500 mb-2"></i>
                            <div class="font-bold text-red-600">救護 119</div>
                        </div>
                    </section>
                </div>

                <!-- TAB 3: 購物清單 -->
                <div v-if="currentTab === 'shopping'" class="animate-fade-in">
                    <div class="grid grid-cols-2 gap-4">
                        <div v-for="(item, index) in shoppingList" :key="index" class="glass rounded-2xl overflow-hidden shadow-sm relative group">
                            <button @click="triggerConfirm('確定移除此購物項目？', () => removeShoppingItem(index))" class="absolute top-2 right-2 bg-black/50 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity hover:bg-black/70 z-10">
                                <i class="fas fa-times"></i>
                            </button>
                            <div class="h-32 bg-gray-200 bg-cover bg-center" :style="{ backgroundImage: `url(${item.image || 'https://via.placeholder.com/150?text=No+Image'})` }"></div>
                            <div class="p-3">
                                <h4 class="font-bold text-sm truncate text-black mb-1">{{ item.name }}</h4>
                                <div class="flex items-center justify-between mt-2">
                                    <div class="flex items-center">
                                        <input type="checkbox" v-model="item.checked" class="w-4 h-4 rounded text-blue-500 focus:ring-blue-500 border-gray-300">
                                        <span class="text-xs text-gray-500 ml-1" :class="{'line-through': item.checked}">已買</span>
                                    </div>
                                    <!-- 顯示金額 -->
                                    <div v-if="item.price" class="text-xs font-bold text-navy-800">
                                        ¥ {{ Number(item.price).toLocaleString() }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button @click="showShoppingModal = true" class="fixed bottom-6 right-6 w-14 h-14 bg-pink-500 text-white rounded-full shadow-2xl flex items-center justify-center text-2xl hover:scale-110 transition-transform z-40 border-2 border-white">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>

                <!-- TAB 4: 開支 -->
                <div v-if="currentTab === 'expenses'" class="animate-fade-in">
                    <div class="bg-navy-900 text-white rounded-2xl p-6 mb-6 shadow-xl relative overflow-hidden">
                        <div class="absolute -right-6 -top-6 w-32 h-32 bg-ice-500 rounded-full opacity-20 blur-2xl"></div>
                        <p class="text-sm opacity-70 mb-1">總支出 (日幣)</p>
                        <h2 class="text-4xl font-bold">¥ {{ totalExpenses.toLocaleString() }}</h2>
                        <p class="text-xs opacity-50 mt-2">約 HKD {{ (totalExpenses / currency.rate).toFixed(1) }}</p>
                    </div>
                    <div class="space-y-3">
                        <div v-for="(exp) in expenses" :key="exp.id" class="glass p-4 rounded-xl flex items-center justify-between">
                            <div class="flex items-center">
                                <div :class="['w-10 h-10 rounded-full flex items-center justify-center text-white mr-3', getExpenseColor(exp.category)]">
                                    <i :class="getExpenseIcon(exp.category)"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold text-sm text-black">{{ exp.name }}</h4>
                                    <p class="text-xs text-gray-500">{{ exp.date }} · {{ exp.method }}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-black">¥ {{ Number(exp.amount).toLocaleString() }}</div>
                                <button @click="triggerConfirm('確定刪除此筆開支紀錄？', () => removeExpense(exp.id))" class="text-[10px] text-red-400 mt-1 hover:text-red-600">刪除</button>
                            </div>
                        </div>
                    </div>
                     <button @click="showExpenseModal = true" class="fixed bottom-6 right-6 w-14 h-14 bg-yellow-500 text-white rounded-full shadow-2xl flex items-center justify-center text-2xl hover:scale-110 transition-transform z-40 border-2 border-white">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>

                <!-- TAB 5: 日語 -->
                <div v-if="currentTab === 'japanese'" class="animate-fade-in pb-10">
                    <div class="flex overflow-x-auto space-x-2 mb-4 no-scrollbar">
                        <button 
                            v-for="cat in japaneseCategories" 
                            @click="currentJpCat = cat"
                            :class="['px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap transition-colors border shadow-sm', currentJpCat === cat ? 'bg-navy-800 text-white border-transparent' : 'bg-white text-gray-500 border-gray-200']"
                        >
                            {{ cat }}
                        </button>
                    </div>
                    <div class="space-y-3">
                        <div v-for="(phrase, index) in filteredJapanese" :key="index" class="glass p-5 rounded-xl flex items-center justify-between group">
                            <div>
                                <h3 class="font-bold text-lg text-black mb-1">{{ phrase.jp }}</h3>
                                <p class="text-sm text-gray-700">{{ phrase.zh }}</p>
                                <p class="text-xs text-gray-400 mt-1 italic">{{ phrase.romaji }}</p>
                            </div>
                            <button @click="speak(phrase.jp)" class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center active:scale-90 transition-transform hover:bg-blue-200">
                                <i class="fas fa-volume-up"></i>
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </main>

        <!-- === Modals === -->

        <!-- 確認刪除 Modal -->
        <div v-if="confirmState.show" class="fixed inset-0 z-[200] bg-black/60 backdrop-blur-sm flex items-center justify-center">
            <div class="bg-white w-[80%] max-w-sm p-6 rounded-3xl shadow-2xl animate-pop-in text-center border border-gray-100">
                 <div class="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
                    <i class="fas fa-exclamation"></i>
                 </div>
                 <h3 class="text-xl font-bold mb-2 text-black">確認刪除？</h3>
                 <p class="text-sm text-gray-600 mb-8">{{ confirmState.msg }}</p>
                 <div class="flex space-x-3">
                     <button @click="confirmState.show = false" class="flex-1 py-3 rounded-2xl bg-gray-100 font-bold text-gray-600 hover:bg-gray-200">取消</button>
                     <button @click="executeConfirm" class="flex-1 py-3 rounded-2xl bg-red-500 text-white font-bold shadow-lg shadow-red-500/30 hover:bg-red-600">刪除</button>
                 </div>
            </div>
        </div>

        <!-- 新增/編輯 行程 Modal -->
        <div v-if="showAddModal" class="fixed inset-0 z-[100] bg-black/50 backdrop-blur-sm flex items-end md:items-center justify-center">
            <div class="bg-white w-full md:w-[500px] rounded-t-3xl md:rounded-3xl p-6 shadow-2xl animate-slide-up max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-black">{{ isEditing ? '編輯行程' : '新增行程' }}</h3>
                    <button @click="showAddModal = false" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="text-xs text-gray-500 mb-1 block">分類</label>
                        <select v-model="form.category" class="w-full bg-gray-50 p-3 rounded-xl outline-none text-black border border-gray-200 focus:border-navy-500 focus:ring-1 focus:ring-navy-500">
                            <option value="sightseeing">景點</option>
                            <option value="food">美食</option>
                            <option value="shopping">購物</option>
                            <option value="hotel">住宿</option>
                            <option value="flight">航班</option>
                            <option value="other">其他</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs text-gray-500 mb-1 block">名稱</label>
                        <input type="text" v-model="form.name" placeholder="例如: 福岡塔" class="w-full bg-gray-50 p-3 rounded-xl outline-none text-black border border-gray-200 focus:border-navy-500 focus:ring-1 focus:ring-navy-500">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500 mb-1 block">開始時間</label>
                        <input type="time" v-model="form.startTime" class="w-full bg-gray-50 p-3 rounded-xl outline-none text-black border border-gray-200 focus:border-navy-500 focus:ring-1 focus:ring-navy-500">
                    </div>
                    <div v-if="form.category === 'flight'" class="grid grid-cols-2 gap-3 bg-gray-50 p-3 rounded-xl border border-gray-200">
                        <input v-model="form.flightCode" placeholder="航班編號" class="p-2 rounded bg-white w-full border border-gray-200 text-black">
                        <input v-model="form.duration" placeholder="飛行時間" class="p-2 rounded bg-white w-full border border-gray-200 text-black">
                        <input v-model="form.depAirport" placeholder="起飛機場" class="p-2 rounded bg-white w-full border border-gray-200 text-black">
                        <input v-model="form.depTime" type="time" class="p-2 rounded bg-white w-full border border-gray-200 text-black">
                        <input v-model="form.arrAirport" placeholder="抵達機場" class="p-2 rounded bg-white w-full border border-gray-200 text-black">
                        <input v-model="form.arrTime" type="time" class="p-2 rounded bg-white w-full border border-gray-200 text-black">
                    </div>
                    <div v-else class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-xs text-gray-500 mb-1 block">營業時間</label>
                            <input type="text" v-model="form.openTime" placeholder="09:00 - 18:00" class="w-full bg-gray-50 p-3 rounded-xl outline-none text-black border border-gray-200 focus:border-navy-500 focus:ring-1 focus:ring-navy-500">
                        </div>
                        <div v-if="form.category === 'sightseeing'">
                            <label class="text-xs text-gray-500 mb-1 block">門票</label>
                            <input type="text" v-model="form.ticketPrice" placeholder="¥ 2000" class="w-full bg-gray-50 p-3 rounded-xl outline-none text-black border border-gray-200 focus:border-navy-500 focus:ring-1 focus:ring-navy-500">
                        </div>
                    </div>
                    <div>
                         <label class="text-xs text-gray-500 mb-1 block">交通方式 (前往此處)</label>
                         <div class="flex space-x-2">
                             <button type="button" @click="form.transportMode = 'walk'" :class="['flex-1 py-2 rounded-lg text-sm border', form.transportMode === 'walk' ? 'bg-navy-800 text-white border-transparent' : 'bg-gray-50 text-gray-600 border-gray-200']"><i class="fas fa-walking"></i> 步行</button>
                             <button type="button" @click="form.transportMode = 'train'" :class="['flex-1 py-2 rounded-lg text-sm border', form.transportMode === 'train' ? 'bg-navy-800 text-white border-transparent' : 'bg-gray-50 text-gray-600 border-gray-200']"><i class="fas fa-subway"></i> 電車</button>
                             <button type="button" @click="form.transportMode = 'car'" :class="['flex-1 py-2 rounded-lg text-sm border', form.transportMode === 'car' ? 'bg-navy-800 text-white border-transparent' : 'bg-gray-50 text-gray-600 border-gray-200']"><i class="fas fa-car"></i> 開車</button>
                         </div>
                    </div>
                    <div>
                        <label class="text-xs text-gray-500 mb-1 block">備註</label>
                        <textarea v-model="form.note" class="w-full bg-gray-50 p-3 rounded-xl outline-none h-20 text-black border border-gray-200 focus:border-navy-500 focus:ring-1 focus:ring-navy-500"></textarea>
                    </div>
                    <div class="flex space-x-3 pt-4">
                        <button v-if="isEditing" @click="triggerConfirm('刪除此行程？', confirmDeleteItineraryItem)" class="flex-1 bg-red-50 text-red-500 py-3 rounded-xl font-bold border border-red-100 hover:bg-red-100">刪除</button>
                        <button @click="saveItinerary" class="flex-[2] bg-navy-900 text-white py-3 rounded-xl font-bold shadow-lg shadow-blue-900/20 hover:bg-navy-800">確認儲存</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. 新增購物 Modal (新增金額) -->
        <div v-if="showShoppingModal" class="fixed inset-0 z-[100] bg-black/50 backdrop-blur-sm flex items-end md:items-center justify-center">
            <div class="bg-white w-full md:w-[400px] rounded-t-3xl md:rounded-3xl p-6 shadow-2xl animate-slide-up">
                <h3 class="text-xl font-bold mb-4 text-black">新增購物清單</h3>
                
                <input type="text" v-model="shoppingForm.name" placeholder="商品名稱" class="w-full bg-gray-50 p-3 rounded-xl mb-3 outline-none text-black border border-gray-200">
                <!-- 新增金額輸入 -->
                <input type="number" v-model="shoppingForm.price" placeholder="預算/金額 (日幣)" class="w-full bg-gray-50 p-3 rounded-xl mb-3 outline-none text-black border border-gray-200">

                <label class="block w-full h-32 border-2 border-dashed border-gray-300 rounded-xl flex flex-col items-center justify-center cursor-pointer mb-4 hover:bg-gray-50 transition-colors">
                    <span v-if="!shoppingForm.preview" class="text-gray-400 text-sm"><i class="fas fa-camera mb-2"></i> 上傳圖片</span>
                    <img v-else :src="shoppingForm.preview" class="h-full w-full object-cover rounded-xl">
                    <input type="file" accept="image/*" class="hidden" @change="handleImageUpload">
                </label>
                <button @click="saveShopping" class="w-full bg-pink-500 text-white py-3 rounded-xl font-bold shadow-md hover:bg-pink-600">加入清單</button>
                <button @click="showShoppingModal = false" class="w-full text-gray-500 py-2 mt-2 text-sm hover:text-gray-700">取消</button>
            </div>
        </div>

        <!-- 3. 新增/編輯 開支 Modal -->
        <div v-if="showExpenseModal" class="fixed inset-0 z-[100] bg-black/50 backdrop-blur-sm flex items-end md:items-center justify-center">
            <div class="bg-white w-full md:w-[400px] rounded-t-3xl md:rounded-3xl p-6 shadow-2xl animate-slide-up">
                <h3 class="text-xl font-bold mb-4 text-black">記帳 (開支)</h3>
                <div class="grid grid-cols-3 gap-2 mb-4">
                    <button v-for="cat in ['交通','飲食','住宿','門票','購物','其他']" 
                        @click="expenseForm.category = cat"
                        :class="['text-xs py-2 rounded-lg border', expenseForm.category === cat ? 'bg-navy-900 text-white border-transparent' : 'text-gray-600 border-gray-200 hover:bg-gray-50']">
                        {{ cat }}
                    </button>
                </div>
                <input type="text" v-model="expenseForm.name" placeholder="項目名稱" class="w-full bg-gray-50 p-3 rounded-xl mb-3 outline-none text-black border border-gray-200">
                <input type="number" v-model="expenseForm.amount" placeholder="金額 (日幣)" class="w-full bg-gray-50 p-3 rounded-xl mb-3 outline-none text-black border border-gray-200">
                <div class="flex space-x-2 mb-4">
                    <button @click="expenseForm.method = '現金'" :class="['flex-1 py-2 rounded-lg text-sm border', expenseForm.method === '現金' ? 'bg-green-500 text-white border-transparent' : 'bg-gray-50 text-gray-600 border-gray-200']">現金</button>
                    <button @click="expenseForm.method = '信用卡'" :class="['flex-1 py-2 rounded-lg text-sm border', expenseForm.method === '信用卡' ? 'bg-blue-500 text-white border-transparent' : 'bg-gray-50 text-gray-600 border-gray-200']">信用卡</button>
                </div>
                <button @click="saveExpense" class="w-full bg-navy-900 text-white py-3 rounded-xl font-bold shadow-md hover:bg-navy-800">儲存</button>
                <button @click="showExpenseModal = false" class="w-full text-gray-500 py-2 mt-2 text-sm hover:text-gray-700">取消</button>
            </div>
        </div>

        <!-- 4. 新增/編輯 資訊 (航班/住宿) Modal -->
        <div v-if="showInfoModal" class="fixed inset-0 z-[100] bg-black/50 backdrop-blur-sm flex items-end md:items-center justify-center">
            <div class="bg-white w-full md:w-[500px] rounded-t-3xl md:rounded-3xl p-6 shadow-2xl animate-slide-up">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-black">{{ infoMode === 'add' ? '新增' : '編輯' }} {{ infoType === 'flight' ? '航班' : '住宿' }}資訊</h3>
                    <button @click="showInfoModal = false" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
                </div>
                <div class="space-y-4">
                    <div v-if="infoType === 'flight'" class="space-y-3">
                        <div class="flex space-x-3">
                             <input v-model="infoForm.title" placeholder="標題 (例: 去程)" class="flex-1 p-3 rounded-xl bg-gray-50 text-black border border-gray-200 outline-none">
                             <input v-model="infoForm.date" type="date" class="flex-1 p-3 rounded-xl bg-gray-50 text-black border border-gray-200 outline-none">
                        </div>
                        <input v-model="infoForm.code" placeholder="航班編號 (例: CX500)" class="w-full p-3 rounded-xl bg-gray-50 text-black border border-gray-200 outline-none">
                        <div class="grid grid-cols-2 gap-3 bg-gray-50 p-3 rounded-xl border border-gray-200">
                            <input v-model="infoForm.depCode" placeholder="起飛機場代碼" class="p-2 rounded bg-white w-full border border-gray-200 text-black">
                            <input v-model="infoForm.depTime" type="time" class="p-2 rounded bg-white w-full border border-gray-200 text-black">
                            <input v-model="infoForm.arrCode" placeholder="抵達機場代碼" class="p-2 rounded bg-white w-full border border-gray-200 text-black">
                            <input v-model="infoForm.arrTime" type="time" class="p-2 rounded bg-white w-full border border-gray-200 text-black">
                        </div>
                         <input v-model="infoForm.duration" placeholder="飛行時間 (例: 4h 10m)" class="w-full p-3 rounded-xl bg-gray-50 text-black border border-gray-200 outline-none">
                    </div>
                    <div v-if="infoType === 'hotel'" class="space-y-3">
                        <input v-model="infoForm.name" placeholder="飯店名稱" class="w-full p-3 rounded-xl bg-gray-50 text-black border border-gray-200 outline-none">
                        <input v-model="infoForm.address" placeholder="地址" class="w-full p-3 rounded-xl bg-gray-50 text-black border border-gray-200 outline-none">
                        <input v-model="infoForm.phone" placeholder="電話" class="w-full p-3 rounded-xl bg-gray-50 text-black border border-gray-200 outline-none">
                    </div>
                    <button @click="saveInfoData" class="w-full bg-navy-900 text-white py-3 rounded-xl font-bold mt-4 shadow-md hover:bg-navy-800">儲存資訊</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, computed, watch, onMounted } = Vue;

        createApp({
            setup() {
                const currentTab = ref('itinerary');
                const selectedDateIndex = ref(0);
                const showAddModal = ref(false);
                const showShoppingModal = ref(false);
                const showExpenseModal = ref(false);
                const showInfoModal = ref(false);
                const isEditing = ref(false);
                const infoMode = ref('add'); 
                const infoType = ref('flight'); 

                const confirmState = ref({ show: false, msg: '', action: null });
                
                // 更新日期：2026年1月2日 (五) - 1月7日 (三)
                const tripDates = ref([
                    { fullDate: '2026-01-02', week: 'Fri', date: '2' },
                    { fullDate: '2026-01-03', week: 'Sat', date: '3' },
                    { fullDate: '2026-01-04', week: 'Sun', date: '4' },
                    { fullDate: '2026-01-05', week: 'Mon', date: '5' },
                    { fullDate: '2026-01-06', week: 'Tue', date: '6' },
                    { fullDate: '2026-01-07', week: 'Wed', date: '7' },
                ]);

                const currency = ref({ rate: 19.5, jpy: 0, hkd: 0 });
                const weather = ref({ temp: 8, feelsLike: 5, status: '晴時多雲', icon: 'fas fa-cloud-sun', isForecast: false });

                // 更新行程資料日期 Key
                const itineraryData = ref({
                    '2026-01-02': [
                        { id: 1, category: 'flight', startTime: '15:30', name: '福岡機場 (FUK) 抵達', note: '領取行李與購買地鐵票', flightCode: 'CX588', depTime: '11:00', arrTime: '15:30', depAirport: 'HKG', arrAirport: 'FUK', duration: '3h30m', transportMode: 'train' },
                        { id: 2, category: 'other', startTime: '16:15', name: '搭乘地鐵至博多站', note: '搭乘福岡市營地鐵空港線，往姪濱方向，約5分鐘到達博多站。', ticketPrice: '¥260/人', transportMode: 'train' },
                        { id: 3, category: 'food', startTime: '18:00', name: '博多拉麵晚餐', note: '前往博多一雙或一蘭本社總本店用餐。', openTime: '11:00 - 24:00', transportMode: 'walk' }
                    ],
                    '2026-01-03': [],
                    '2026-01-04': [],
                    '2026-01-05': [],
                    '2026-01-06': [],
                    '2026-01-07': []
                });

                // 更新航班日期
                const flights = ref([
                    { id: 101, title: '去程', date: '01/02', code: 'CX588', depCode: 'HKG', depTime: '11:00', arrCode: 'FUK', arrTime: '15:30', duration: '3h 30m' },
                    { id: 102, title: '回程', date: '01/07', code: 'CX589', depCode: 'FUK', depTime: '16:40', arrCode: 'HKG', arrTime: '19:55', duration: '4h 15m' }
                ]);
                const hotels = ref([
                    { id: 201, name: '都酒店 博多', address: '福岡市博多區博多駅東2-1-1', phone: '+81 92-441-3111' }
                ]);
                const infoForm = ref({});
                const shoppingList = ref([]);
                const shoppingForm = ref({ name: '', price: '', preview: null }); // add price
                const expenses = ref([]);
                const expenseForm = ref({ id: null, category: '飲食', name: '', amount: '', method: '現金', date: '' });
                const form = ref({ id: null, category: 'sightseeing', startTime: '', name: '', openTime: '', ticketPrice: '', note: '', transportMode: 'train' });

                // 擴充日語資料庫 (每個分類至少 5-6 句)
                const japaneseData = [
                    // 基本應對
                    { cat: '基本應對', jp: 'こんにちは', romaji: 'Konnichiwa', zh: '你好 (白天)' },
                    { cat: '基本應對', jp: 'ありがとうございます', romaji: 'Arigatou gozaimasu', zh: '謝謝' },
                    { cat: '基本應對', jp: 'すみません', romaji: 'Sumimasen', zh: '不好意思 / 請問' },
                    { cat: '基本應對', jp: 'はい / いいえ', romaji: 'Hai / Iie', zh: '是 / 不是' },
                    { cat: '基本應對', jp: 'おはようございます', romaji: 'Ohayou gozaimasu', zh: '早安' },
                    { cat: '基本應對', jp: 'こんばんは', romaji: 'Konbanwa', zh: '晚安' },

                    // 購物結帳
                    { cat: '購物結帳', jp: 'これはいくらですか？', romaji: 'Kore wa ikura desu ka?', zh: '請問這個多少錢？' },
                    { cat: '購物結帳', jp: 'クレジットカードは使えますか？', romaji: 'Kurejitto ka-do wa tsukaemasu ka?', zh: '可以用信用卡嗎？' },
                    { cat: '購物結帳', jp: '免税できますか？', romaji: 'Menzei dekimasu ka?', zh: '可以免稅嗎？' },
                    { cat: '購物結帳', jp: '袋をください', romaji: 'Fukuro o kudasai', zh: '請給我袋子' },
                    { cat: '購物結帳', jp: 'これをください', romaji: 'Kore o kudasai', zh: '我要這個' },
                    { cat: '購物結帳', jp: '試着してもいいですか？', romaji: 'Shichaku shitemo ii desu ka?', zh: '可以試穿嗎？' },

                    // 餐廳點餐
                    { cat: '餐廳點餐', jp: 'メニューをください', romaji: 'Menyu wo kudasai', zh: '請給我菜單' },
                    { cat: '餐廳點餐', jp: 'お水をください', romaji: 'Omizu wo kudasai', zh: '請給我水' },
                    { cat: '餐廳點餐', jp: '注文をお願いします', romaji: 'Chuumon wo onegaishimasu', zh: '我要點餐' },
                    { cat: '餐廳點餐', jp: 'おすすめは何ですか？', romaji: 'Osusume wa nan desu ka?', zh: '有什麼推薦的嗎？' },
                    { cat: '餐廳點餐', jp: 'お会計をお願いします', romaji: 'Okaikei wo onegaishimasu', zh: '我要結帳' },
                    { cat: '餐廳點餐', jp: 'ごちそうさまでした', romaji: 'Gochisousama deshita', zh: '多謝款待 (吃飽後說)' },

                    // 交通問路
                    { cat: '交通問路', jp: '駅はどこですか？', romaji: 'Eki wa doko desu ka?', zh: '請問車站在哪裡？' },
                    { cat: '交通問路', jp: 'このバスは博多に行きますか？', romaji: 'Kono basu wa Hakata ni ikimasu ka?', zh: '這輛巴士去博多嗎？' },
                    { cat: '交通問路', jp: 'ここに行きたいです', romaji: 'Koko ni ikitai desu', zh: '我想去這裡 (指著地圖)' },
                    { cat: '交通問路', jp: '切符売り場はどこですか？', romaji: 'Kippu uriba wa doko desu ka?', zh: '售票處在哪裡？' },
                    { cat: '交通問路', jp: 'タクシー乗り場', romaji: 'Takushii noriba', zh: '計程車招呼站' },
                    { cat: '交通問路', jp: 'トイレはどこですか？', romaji: 'Toire wa doko desu ka?', zh: '廁所在哪裡？' },

                    // 緊急狀況
                    { cat: '緊急狀況', jp: '助けてください', romaji: 'Tasukete kudasai', zh: '救命 / 請幫幫我' },
                    { cat: '緊急狀況', jp: 'パスポートをなくしました', romaji: 'Pasupooto wo nakushimashita', zh: '我遺失了護照' },
                    { cat: '緊急狀況', jp: '気分が悪いです', romaji: 'Kibun ga warui desu', zh: '我不舒服' },
                    { cat: '緊急狀況', jp: '警察を呼んでください', romaji: 'Keisatsu wo yonde kudasai', zh: '請叫警察' },
                    { cat: '緊急狀況', jp: '救急車を呼んでください', romaji: 'Kyuukyuusha wo yonde kudasai', zh: '請叫救護車' },
                    { cat: '緊急狀況', jp: '道に迷いました', romaji: 'Michi ni mayoi mashita', zh: '我迷路了' },
                ];
                const currentJpCat = ref('基本應對');

                const tabs = [
                    { id: 'itinerary', name: '行程', icon: 'fas fa-map-marked-alt' },
                    { id: 'info', name: '資訊', icon: 'fas fa-info-circle' },
                    { id: 'shopping', name: '購物', icon: 'fas fa-shopping-basket' },
                    { id: 'expenses', name: '開支', icon: 'fas fa-yen-sign' },
                    { id: 'japanese', name: '日語', icon: 'fas fa-language' }
                ];

                const currentKey = computed(() => {
                    if (tripDates.value.length === 0) return '';
                    if (!tripDates.value[selectedDateIndex.value]) return tripDates.value[0].fullDate;
                    return tripDates.value[selectedDateIndex.value].fullDate;
                });
                const currentDayItinerary = computed(() => itineraryData.value[currentKey.value] || []);
                const totalExpenses = computed(() => expenses.value.reduce((sum, item) => sum + Number(item.amount), 0));
                const japaneseCategories = ['基本應對', '購物結帳', '餐廳點餐', '交通問路', '緊急狀況'];
                const filteredJapanese = computed(() => japaneseData.filter(i => i.cat === currentJpCat.value));

                const triggerConfirm = (msg, action) => {
                    confirmState.value.msg = msg;
                    confirmState.value.action = action;
                    confirmState.value.show = true;
                };
                const executeConfirm = () => {
                    if (confirmState.value.action) confirmState.value.action();
                    confirmState.value.show = false;
                };

                const addDay = () => {
                    const lastDay = tripDates.value[tripDates.value.length - 1];
                    const nextDate = new Date(lastDay.fullDate);
                    nextDate.setDate(nextDate.getDate() + 1);
                    const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                    tripDates.value.push({
                        fullDate: nextDate.toISOString().split('T')[0],
                        week: days[nextDate.getDay()],
                        date: nextDate.getDate().toString()
                    });
                    itineraryData.value[tripDates.value[tripDates.value.length - 1].fullDate] = [];
                    selectedDateIndex.value = tripDates.value.length - 1;
                    saveData();
                };

                const deleteDay = (index) => {
                    if (tripDates.value.length <= 1) return;
                    if (index === selectedDateIndex.value) selectedDateIndex.value = 0;
                    else if (index < selectedDateIndex.value) selectedDateIndex.value--;
                    tripDates.value.splice(index, 1);
                    saveData();
                };

                const openMap = (keyword) => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(keyword)}`, '_blank');
                const calculateTravelTime = (prev, curr) => curr.transportMode === 'walk' ? '15 分鐘' : curr.transportMode === 'car' ? '25 分鐘' : '10 分鐘';

                const dragStart = (index) => { event.dataTransfer.setData('text/plain', index); };
                const drop = (toIndex) => {
                    const fromIndex = event.dataTransfer.getData('text/plain');
                    if (fromIndex === '') return;
                    const list = itineraryData.value[currentKey.value];
                    const element = list.splice(fromIndex, 1)[0];
                    list.splice(toIndex, 0, element);
                    saveData();
                };

                const moveItem = (index, direction) => {
                    const list = itineraryData.value[currentKey.value];
                    const newIndex = index + direction;
                    if (newIndex >= 0 && newIndex < list.length) {
                        const temp = list[index];
                        list[index] = list[newIndex];
                        list[newIndex] = temp;
                        saveData();
                    }
                };

                const resetForm = () => { form.value = { id: null, category: 'sightseeing', startTime: '', name: '', openTime: '', ticketPrice: '', note: '', transportMode: 'train', flightCode: '', duration: '', depAirport: '', depTime: '', arrAirport: '', arrTime: '' }; };
                const saveItinerary = () => {
                    const list = itineraryData.value[currentKey.value];
                    if (isEditing.value) {
                        const idx = list.findIndex(i => i.id === form.value.id);
                        if(idx !== -1) list[idx] = { ...form.value };
                    } else {
                        form.value.id = Date.now();
                        list.push({ ...form.value });
                    }
                    saveData();
                    showAddModal.value = false;
                };
                const editItem = (item) => { form.value = { ...item }; isEditing.value = true; showAddModal.value = true; };
                const confirmDeleteItineraryItem = () => {
                    const list = itineraryData.value[currentKey.value];
                    const idx = list.findIndex(i => i.id === form.value.id);
                    if(idx !== -1) list.splice(idx, 1);
                    saveData();
                    showAddModal.value = false;
                };

                const openInfoModal = (type, mode, data = null) => { infoType.value = type; infoMode.value = mode; infoForm.value = mode === 'edit' && data ? { ...data } : { id: null }; showInfoModal.value = true; };
                const saveInfoData = () => {
                    if (infoType.value === 'flight') {
                        if (infoMode.value === 'add') { infoForm.value.id = Date.now(); flights.value.push({ ...infoForm.value }); }
                        else { const idx = flights.value.findIndex(f => f.id === infoForm.value.id); if (idx !== -1) flights.value[idx] = { ...infoForm.value }; }
                    } else if (infoType.value === 'hotel') {
                        if (infoMode.value === 'add') { infoForm.value.id = Date.now(); hotels.value.push({ ...infoForm.value }); }
                        else { const idx = hotels.value.findIndex(h => h.id === infoForm.value.id); if (idx !== -1) hotels.value[idx] = { ...infoForm.value }; }
                    }
                    saveData(); showInfoModal.value = false;
                };
                const deleteInfoData = (type, id) => { 
                    if (type === 'flight') { const idx = flights.value.findIndex(f => f.id === id); if (idx !== -1) flights.value.splice(idx, 1); } 
                    else if (type === 'hotel') { const idx = hotels.value.findIndex(h => h.id === id); if (idx !== -1) hotels.value.splice(idx, 1); }
                    saveData(); 
                };

                // 天氣 API 相關邏輯
                const weatherCodeMap = {
                    0: { icon: 'fas fa-sun', label: '晴朗' },
                    1: { icon: 'fas fa-cloud-sun', label: '多雲' },
                    2: { icon: 'fas fa-cloud-sun', label: '多雲' },
                    3: { icon: 'fas fa-cloud', label: '陰天' },
                    45: { icon: 'fas fa-smog', label: '霧' },
                    48: { icon: 'fas fa-smog', label: '霧' },
                    51: { icon: 'fas fa-cloud-rain', label: '毛毛雨' },
                    53: { icon: 'fas fa-cloud-rain', label: '毛毛雨' },
                    55: { icon: 'fas fa-cloud-rain', label: '毛毛雨' },
                    61: { icon: 'fas fa-umbrella', label: '小雨' },
                    63: { icon: 'fas fa-umbrella', label: '中雨' },
                    65: { icon: 'fas fa-umbrella', label: '大雨' },
                    71: { icon: 'fas fa-snowflake', label: '小雪' },
                    73: { icon: 'fas fa-snowflake', label: '中雪' },
                    75: { icon: 'fas fa-snowflake', label: '大雪' },
                    95: { icon: 'fas fa-bolt', label: '雷雨' },
                };

                const fetchWeather = async () => {
                    const lat = 33.5904; // Fukuoka
                    const lon = 130.4017;
                    const dateStr = currentKey.value; // YYYY-MM-DD
                    
                    const today = new Date().toISOString().split('T')[0];
                    const selectedDate = new Date(dateStr);
                    const now = new Date();
                    const diffTime = selectedDate - now;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 

                    // 判斷是否在預報範圍內 (Open-Meteo 免費版約 14-16 天)
                    const isWithinForecastRange = diffDays >= 0 && diffDays <= 14;

                    try {
                        let url = '';
                        if (isWithinForecastRange) {
                            // 抓取特定日期的預報
                            url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=Asia%2FTokyo&start_date=${dateStr}&end_date=${dateStr}`;
                        } else {
                            // 超出範圍，抓取當前即時天氣
                            url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&timezone=Asia%2FTokyo`;
                        }

                        const res = await fetch(url);
                        const data = await res.json();

                        if (isWithinForecastRange && data.daily) {
                            // 顯示預報
                            const max = data.daily.temperature_2m_max[0];
                            const min = data.daily.temperature_2m_min[0];
                            const code = data.daily.weathercode[0];
                            const weatherInfo = weatherCodeMap[code] || { icon: 'fas fa-cloud', label: '陰天' };
                            
                            weather.value = {
                                temp: Math.round((max + min) / 2),
                                feelsLike: Math.round(min), // 簡單模擬體感
                                status: weatherInfo.label,
                                icon: weatherInfo.icon,
                                isForecast: true
                            };
                        } else if (data.current_weather) {
                            // 顯示即時天氣
                            const current = data.current_weather;
                            const code = current.weathercode;
                            const weatherInfo = weatherCodeMap[code] || { icon: 'fas fa-cloud', label: '陰天' };

                            weather.value = {
                                temp: Math.round(current.temperature),
                                feelsLike: Math.round(current.temperature - 2), // 冬天體感通常較低
                                status: weatherInfo.label,
                                icon: weatherInfo.icon,
                                isForecast: false
                            };
                        }
                    } catch (e) {
                        console.error("Weather fetch failed", e);
                        // 失敗時保持預設值
                    }
                };

                // 監聽日期變換，重新抓取天氣
                watch(selectedDateIndex, () => {
                    fetchWeather();
                });

                const updateExchangeRate = async () => {
                    try {
                        const res = await fetch('https://open.er-api.com/v6/latest/HKD');
                        const data = await res.json();
                        if (data && data.rates && data.rates.JPY) {
                            currency.value.rate = data.rates.JPY.toFixed(2);
                            if (currency.value.hkd > 0) convertCurrency('hkd');
                        }
                    } catch (e) { console.error('Failed to fetch rate'); }
                };

                const convertCurrency = (type) => { if(type === 'jpy') currency.value.hkd = (currency.value.jpy / currency.value.rate).toFixed(2); else currency.value.jpy = (currency.value.hkd * currency.value.rate).toFixed(0); };
                const handleImageUpload = (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => shoppingForm.value.preview = e.target.result; reader.readAsDataURL(file); };
                const saveShopping = () => { if(!shoppingForm.value.name) return; shoppingList.value.push({ name: shoppingForm.value.name, price: shoppingForm.value.price, image: shoppingForm.value.preview, checked: false }); shoppingForm.value = { name: '', price: '', preview: null }; showShoppingModal.value = false; saveData(); }; // Update saveShopping to include price
                const removeShoppingItem = (index) => { shoppingList.value.splice(index, 1); saveData(); };
                const saveExpense = () => { if(!expenseForm.value.name || !expenseForm.value.amount) return; expenses.value.push({ ...expenseForm.value, id: Date.now(), date: tripDates.value[selectedDateIndex.value].fullDate }); expenseForm.value = { id: null, category: '飲食', name: '', amount: '', method: '現金', date: '' }; showExpenseModal.value = false; saveData(); };
                const removeExpense = (id) => { const index = expenses.value.findIndex(exp => exp.id === id); if (index !== -1) expenses.value.splice(index, 1); saveData(); };
                const speak = (text) => { const utterance = new SpeechSynthesisUtterance(text); utterance.lang = 'ja-JP'; window.speechSynthesis.speak(utterance); };
                const callNumber = (num) => window.location.href = `tel:${num}`;

                const getCategoryName = (cat) => ({ sightseeing: '景點', food: '美食', shopping: '購物', hotel: '住宿', flight: '航班', other: '其他' }[cat] || '其他');
                const getCategoryColor = (cat) => ({ sightseeing: 'bg-green-500', food: 'bg-orange-400', shopping: 'bg-pink-500', hotel: 'bg-indigo-500', flight: 'bg-blue-600', other: 'bg-gray-500' }[cat]);
                const getCategoryIcon = (cat) => ({ sightseeing: 'fas fa-camera', food: 'fas fa-utensils', shopping: 'fas fa-shopping-bag', hotel: 'fas fa-bed', flight: 'fas fa-plane', other: 'fas fa-map-marker-alt' }[cat]);
                const getTransportIcon = (mode) => mode === 'walk' ? 'fas fa-walking' : mode === 'car' ? 'fas fa-car' : 'fas fa-subway';
                const getExpenseIcon = (cat) => ({ '交通': 'fas fa-train', '飲食': 'fas fa-utensils', '住宿': 'fas fa-bed', '門票': 'fas fa-ticket-alt', '購物': 'fas fa-shopping-bag', '其他': 'fas fa-circle' }[cat]);
                const getExpenseColor = (cat) => ({ '交通': 'bg-blue-400', '飲食': 'bg-orange-400', '住宿': 'bg-indigo-400', '門票': 'bg-green-400', '購物': 'bg-pink-400', '其他': 'bg-gray-400' }[cat]);

                const saveData = () => localStorage.setItem('snowTravelData', JSON.stringify({ tripDates: tripDates.value, itinerary: itineraryData.value, shopping: shoppingList.value, expenses: expenses.value, flights: flights.value, hotels: hotels.value }));
                const loadData = () => { 
                    const saved = localStorage.getItem('snowTravelData'); 
                    if (saved) { 
                        const parsed = JSON.parse(saved); 
                        Object.assign(itineraryData.value, parsed.itinerary); 
                        tripDates.value = parsed.tripDates || tripDates.value; 
                        shoppingList.value = parsed.shopping || []; 
                        expenses.value = parsed.expenses || []; 
                        flights.value = parsed.flights || []; 
                        // Migration for old single hotel object
                        if (parsed.hotel && !parsed.hotels) { hotels.value = [parsed.hotel]; }
                        else { hotels.value = parsed.hotels || hotels.value; }
                    }
                };

                onMounted(() => {
                    loadData();
                    updateExchangeRate();
                    fetchWeather(); // 初始抓取天氣
                });

                return { currentTab, tabs, tripDates, selectedDateIndex, weather, currency, currentDayItinerary, showAddModal, isEditing, form, saveItinerary, editItem, confirmDeleteItineraryItem, resetForm, dragStart, drop, addDay, deleteDay, openMap, calculateTravelTime, shoppingList, showShoppingModal, shoppingForm, handleImageUpload, saveShopping, removeShoppingItem, expenses, showExpenseModal, expenseForm, saveExpense, removeExpense, totalExpenses, japaneseCategories, currentJpCat, filteredJapanese, speak, callNumber, convertCurrency, flights, hotels, showInfoModal, infoMode, infoType, infoForm, openInfoModal, saveInfoData, deleteInfoData, confirmState, triggerConfirm, executeConfirm, getCategoryName, getCategoryColor, getCategoryIcon, getTransportIcon, getExpenseIcon, getExpenseColor, moveItem };
            }
        }).mount('#app');
    </script>
</body>
</html>