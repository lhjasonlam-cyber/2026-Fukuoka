<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 福岡之旅 | SnowTravel</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Noto Sans TC', 'sans-serif'] },
                    colors: {
                        navy: { 50: '#f0f4f8', 100: '#d9e2ec', 500: '#334e68', 800: '#102a43', 900: '#0b1d30' },
                        ice: { 100: '#e3f8ff', 500: '#40c3f7' }
                    },
                    animation: {
                        'pop-in': 'pop-in 0.2s ease-out forwards',
                        'slide-up': 'slide-up 0.3s ease-out forwards',
                    },
                    keyframes: {
                        'pop-in': { '0%': { transform: 'scale(0.9)', opacity: '0' }, '100%': { transform: 'scale(1)', opacity: '1' } },
                        'slide-up': { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } }
                    }
                }
            }
        }
    </script>

    <!-- FontAwesome & Chart.js -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .glass { background: #ffffff; border: 1px solid #e5e7eb; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); color: #000; }
        .bg-light-navy { background-color: #eef2f6; border-color: #dbe4ee; }
        .banner-gradient { background: linear-gradient(180deg, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.4) 100%); }
        body { background-color: #ffffff; }
    </style>
</head>
<body class="text-black antialiased pb-24 bg-white">

    <div id="app">
        
        <!-- Banner -->
        <header class="relative w-full h-[280px] md:h-[350px] flex items-center justify-center overflow-hidden shadow-lg bg-navy-900">
            <div class="absolute top-0 left-0 w-full h-full bg-[url('banner.jpg')] bg-cover bg-center"></div>
            <div class="absolute top-0 left-0 w-full h-full banner-gradient"></div>
            
            <div class="relative z-10 text-center text-white px-4 -mt-24">
                <h1 class="text-3xl font-bold tracking-[0.2em] mb-2 drop-shadow-md">2026・福岡</h1>
            </div>

            <!-- Tabs -->
            <div class="absolute bottom-12 right-4 z-50 flex space-x-3 overflow-x-auto p-2 no-scrollbar">
                <button v-for="tab in tabs" :key="tab.id" @click="currentTab = tab.id"
                    :class="['flex flex-col items-center justify-center w-14 h-14 rounded-2xl transition-all duration-300 shadow-lg backdrop-blur-md border border-white/20', currentTab === tab.id ? 'bg-ice-500 text-white scale-110 shadow-ice-500/50' : 'bg-white/20 text-white hover:bg-white/30']">
                    <i :class="tab.icon + ' text-xl mb-1'"></i>
                    <span class="text-[10px] font-bold">{{ tab.name }}</span>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="relative -mt-10 bg-white rounded-t-[2.5rem] min-h-screen shadow-[0_-10px_40px_rgba(0,0,0,0.05)] overflow-hidden transition-colors duration-300">
            
            <div class="pt-8 pb-32 px-4 md:px-6 max-w-3xl mx-auto">

                <div v-if="loading" class="flex flex-col items-center justify-center py-20 text-gray-400">
                    <i class="fas fa-circle-notch fa-spin text-3xl mb-3 text-navy-500"></i>
                    <p>正在連線至 Firebase...</p>
                </div>

                <div v-else>
                    <!-- 1. 行程表 -->
                    <div v-if="currentTab === 'itinerary'" class="animate-fade-in">
                        <div class="flex space-x-4 overflow-x-auto no-scrollbar mb-6 pb-2 items-center pt-2">
                            <div v-for="(day, index) in tripDates" :key="index" @click="selectedDateIndex = index"
                                :class="['relative flex-shrink-0 flex flex-col items-center justify-center w-16 h-20 rounded-2xl cursor-pointer transition-all border group shadow-sm', selectedDateIndex === index ? 'bg-navy-800 text-white border-transparent transform scale-105' : 'bg-white text-gray-500 border-gray-200 hover:border-gray-400']">
                                <button @click.stop="triggerConfirm('確定刪除此日？', () => deleteDay(index))" v-if="tripDates.length > 1" class="absolute -top-2 -right-2 w-5 h-5 bg-red-500 text-white rounded-full flex items-center justify-center shadow-md z-10"><i class="fas fa-times text-[10px]"></i></button>
                                <span class="text-xs font-medium uppercase">{{ day.week }}</span>
                                <span class="text-2xl font-bold">{{ day.date }}</span>
                            </div>
                            <button @click="addDay" class="flex-shrink-0 flex items-center justify-center w-16 h-20 rounded-2xl cursor-pointer transition-all border bg-gray-50 text-gray-400 border-gray-200 hover:bg-gray-100 active:scale-95 shadow-sm"><i class="fas fa-plus text-xl"></i></button>
                        </div>

                        <div class="bg-gradient-to-r from-blue-400 to-ice-500 text-white rounded-2xl p-4 mb-8 shadow-lg flex items-center justify-between">
                            <div>
                                <div class="text-sm opacity-90 mb-1 flex items-center"><i class="fas fa-location-dot mr-1"></i> 福岡 <span class="ml-2 text-[10px] bg-white/20 px-1.5 rounded">{{ weather.isForecast ? '預報' : '即時' }}</span></div>
                                <div class="text-3xl font-bold">{{ weather.temp }}°C</div>
                                <div class="text-xs opacity-80">體感 {{ weather.feelsLike }}°C</div>
                            </div>
                            <div class="text-center"><i :class="weather.icon + ' text-4xl mb-1'"></i><div class="text-xs font-bold">{{ weather.status }}</div></div>
                        </div>

                        <div class="space-y-6 relative">
                            <div v-if="currentDayItinerary.length === 0" class="text-center py-10 text-gray-400"><i class="fas fa-map-signs text-4xl mb-3 opacity-50"></i><p>點擊右下角 + 新增今日行程</p></div>
                            <div v-if="currentDayItinerary.length > 0" class="absolute top-6 bottom-6 left-[2.25rem] w-0.5 border-l-2 border-dashed border-gray-200 z-0"></div>
                            <div v-for="(item, index) in currentDayItinerary" :key="item.id" class="relative z-10 group" draggable="true" @dragstart="dragStart(index)" @dragover.prevent @drop="drop(index)">
                                <div v-if="index > 0" class="flex items-center ml-14 mb-2"><div class="bg-gray-100 text-gray-500 text-xs px-3 py-1 rounded-full border border-gray-200 flex items-center"><i :class="getTransportIcon(item.transportMode) + ' mr-2'"></i><span>約 {{ calculateTravelTime(currentDayItinerary[index-1], item) }}</span></div></div>
                                <div v-if="index === 0 && item.category !== 'flight'" class="flex items-center ml-14 mb-2"><div class="bg-gray-100 text-gray-500 text-xs px-3 py-1 rounded-full border border-gray-200 flex items-center"><i class="fas fa-hotel mr-2"></i><span>飯店出發</span><i class="fas fa-walking mx-2"></i><span>約 20 分</span></div></div>
                                <div class="flex bg-white rounded-2xl p-4 shadow-sm border border-gray-100 relative overflow-visible" @click="openMap(item.name)">
                                    <div class="flex flex-col items-center mr-4 min-w-[3.5rem] z-10"><div :class="['w-14 h-14 rounded-full flex items-center justify-center text-white text-xl mb-2 shadow-md', getCategoryColor(item.category)]"><i :class="getCategoryIcon(item.category)"></i></div><div class="text-sm font-bold text-gray-800 font-mono">{{ item.startTime || '--:--' }}</div></div>
                                    <div class="flex-1 min-w-0 pt-1">
                                        <h3 class="text-lg font-bold text-gray-900 mb-1 leading-tight">{{ item.name }}</h3>
                                        <div class="flex items-center text-xs text-gray-500 mb-2 truncate"><i :class="item.category === 'flight' ? 'fas fa-plane' : 'fas fa-map-marker-alt'" class="mr-1.5 opacity-70"></i><span>{{ item.category === 'flight' ? item.flightCode : item.name }}</span></div>
                                        <div class="flex flex-wrap gap-x-3 gap-y-1 text-xs text-gray-500 mb-3"><span v-if="item.ticketPrice" class="flex items-center text-orange-600 font-medium bg-orange-50 px-1.5 py-0.5 rounded"><i class="fas fa-ticket-alt mr-1"></i> {{ item.ticketPrice }}</span><span v-if="item.openTime" class="flex items-center"><i class="far fa-clock mr-1"></i> {{ item.openTime }}</span></div>
                                        <div v-if="item.note" class="bg-gray-50 rounded-lg p-2.5 text-xs text-gray-600 flex items-start border border-gray-100"><i class="fas fa-pen text-yellow-500 mt-0.5 mr-2"></i><span class="leading-relaxed">{{ item.note }}</span></div>
                                    </div>
                                    <div class="flex flex-col justify-between items-center ml-2 pl-2 border-l border-gray-100 space-y-1">
                                        <div class="flex flex-col space-y-1"><button v-if="index > 0" @click.stop="moveItem(index, -1)" class="w-6 h-6 flex items-center justify-center text-gray-300 hover:text-navy-500"><i class="fas fa-chevron-up text-xs"></i></button><div v-else class="h-6"></div><button v-if="index < currentDayItinerary.length - 1" @click.stop="moveItem(index, 1)" class="w-6 h-6 flex items-center justify-center text-gray-300 hover:text-navy-500"><i class="fas fa-chevron-down text-xs"></i></button><div v-else class="h-6"></div></div>
                                        <div class="flex flex-col space-y-2 mt-auto pb-1"><button @click.stop="openMap(item.name)" class="w-8 h-8 rounded-full bg-ice-100 text-ice-500 hover:bg-ice-500 hover:text-white flex items-center justify-center shadow-sm"><i class="fas fa-location-arrow text-xs"></i></button><button @click.stop="editItem(item)" class="w-8 h-8 flex items-center justify-center text-gray-300 hover:text-blue-500"><i class="fas fa-pen text-xs"></i></button></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button @click="showAddModal = true; isEditing = false; resetForm()" class="fixed bottom-6 right-6 w-14 h-14 bg-navy-900 text-white rounded-full shadow-2xl flex items-center justify-center text-2xl hover:scale-110 transition-transform z-40 border-2 border-white"><i class="fas fa-plus"></i></button>
                    </div>

                    <!-- 2. 資訊 -->
                    <div v-if="currentTab === 'info'" class="space-y-6 animate-fade-in">
                        <!-- 匯率換算 (修正參數邏輯) -->
                        <section class="bg-light-navy rounded-2xl p-5 shadow-sm border">
                            <h3 class="text-black font-bold mb-4 flex items-center justify-between"><span class="flex items-center"><i class="fas fa-coins mr-2 text-yellow-500"></i> 匯率換算</span><span class="text-[10px] bg-green-100 text-green-600 px-2 py-1 rounded-full">即時匯率</span></h3>
                            <div class="flex items-center space-x-2"><div class="flex-1"><label class="text-xs text-gray-500 block mb-1">日幣 (JPY)</label><input type="number" v-model="currency.jpy" @input="convertCurrency('jpy')" class="w-full bg-white rounded-lg p-2 font-mono text-lg text-black outline-none border"></div><i class="fas fa-exchange-alt text-gray-400 mt-5"></i><div class="flex-1"><label class="text-xs text-gray-500 block mb-1">港幣 (HKD)</label><input type="number" v-model="currency.hkd" @input="convertCurrency('hkd')" class="w-full bg-white rounded-lg p-2 font-mono text-lg text-black outline-none border"></div></div>
                            <p class="text-[10px] text-right text-gray-400 mt-2">1 JPY ≈ {{ currency.rate }} HKD</p>
                        </section>

                        <section class="space-y-4">
                             <div class="flex items-center justify-between px-1"><h3 class="text-black font-bold flex items-center"><i class="fas fa-plane-departure mr-2 text-blue-500"></i> 航班資訊</h3><button @click="openInfoModal('flight', 'add')" class="text-xs bg-blue-100 text-blue-600 px-3 py-1.5 rounded-full hover:bg-blue-200 font-bold"><i class="fas fa-plus mr-1"></i> 新增</button></div>
                            <div v-for="(flight, index) in flights" :key="flight.id" :class="['rounded-xl p-5 pb-16 relative group border shadow-sm', flight.title === '去程' ? 'bg-blue-50 border-blue-100' : 'bg-indigo-50 border-indigo-100']">
                                 <div class="absolute bottom-1 right-3 flex space-x-2"><button @click="openInfoModal('flight', 'edit', flight)" class="w-8 h-8 rounded-full bg-white/80 text-gray-500 hover:text-blue-500 flex items-center justify-center shadow-sm"><i class="fas fa-pen text-xs"></i></button><button @click="triggerConfirm('確定刪除此航班？', () => deleteInfoData('flight', flight.id))" class="w-8 h-8 rounded-full bg-white/80 text-gray-500 hover:text-red-500 flex items-center justify-center shadow-sm"><i class="fas fa-trash text-xs"></i></button></div>
                                <div class="flex justify-between text-xs font-bold text-gray-500 mb-3"><span class="bg-white/60 px-2 py-1 rounded">{{ flight.title }} {{ flight.date }}</span><span class="font-mono text-sm text-navy-800">{{ flight.code }}</span></div>
                                <div class="flex justify-between items-center text-black px-2">
                                    <div><div class="text-3xl font-bold">{{ flight.depCode }}</div><div class="text-xs text-gray-600 font-bold mt-1">{{ flight.depTime }}</div></div>
                                    <div class="text-xs text-gray-400 flex flex-col items-center"><span class="mb-1 text-[10px]">{{ flight.duration }}</span><div class="relative w-16 h-8 flex items-center justify-center"><i class="fas fa-plane text-2xl transition-transform" :style="{ display: 'inline-block', transform: flight.title === '去程' ? 'rotate(90deg)' : 'rotate(-90deg)', color: flight.title === '去程' ? '#60A5FA' : '#818CF8' }"></i></div></div>
                                    <div class="text-right"><div class="text-3xl font-bold">{{ flight.arrCode }}</div><div class="text-xs text-gray-600 font-bold mt-1">{{ flight.arrTime }}</div></div>
                                </div>
                            </div>
                        </section>

                        <section class="space-y-4">
                            <div class="flex items-center justify-between px-1"><h3 class="text-black font-bold flex items-center"><i class="fas fa-bed mr-2 text-indigo-500"></i> 住宿資訊</h3><button @click="openInfoModal('hotel', 'add')" class="text-xs bg-indigo-100 text-indigo-600 px-3 py-1.5 rounded-full hover:bg-indigo-200 font-bold"><i class="fas fa-plus mr-1"></i> 新增</button></div>
                            <div v-for="(h, index) in hotels" :key="h.id" class="glass rounded-xl p-5 border-l-4 border-l-indigo-500 border-t border-r border-b border-gray-200 relative">
                                <div class="absolute bottom-3 right-3 flex space-x-2"><button @click="openInfoModal('hotel', 'edit', h)" class="w-8 h-8 rounded-full bg-gray-100 text-gray-500 hover:text-blue-500 flex items-center justify-center"><i class="fas fa-pen text-xs"></i></button><button @click="triggerConfirm('確定刪除此住宿？', () => deleteInfoData('hotel', h.id))" class="w-8 h-8 rounded-full bg-gray-100 text-gray-500 hover:text-red-500 flex items-center justify-center"><i class="fas fa-trash text-xs"></i></button></div>
                                <h4 class="font-bold text-lg text-black pr-16">{{ h.name }}</h4>
                                <div class="space-y-2 mt-3 mb-6"><p class="text-sm text-gray-600 flex items-start"><i class="fas fa-map-marker-alt mr-2 mt-1 text-indigo-400 w-4 text-center"></i> {{ h.address }}</p><p class="text-sm text-gray-600 flex items-center"><i class="fas fa-phone mr-2 text-indigo-400 w-4 text-center"></i> {{ h.phone }}</p></div>
                                <button @click="openMap(h.name + ' ' + h.address)" class="text-xs bg-indigo-50 text-indigo-600 px-3 py-1.5 rounded-full font-bold hover:bg-indigo-100 border border-indigo-100"><i class="fas fa-location-arrow mr-1"></i> 導航前往</button>
                            </div>
                        </section>
                        
                        <section class="grid grid-cols-2 gap-4"><div class="bg-red-50 p-4 rounded-2xl text-center cursor-pointer border border-red-100 hover:bg-red-100" @click="callNumber('110')"><i class="fas fa-user-shield text-3xl text-red-500 mb-2"></i><div class="font-bold text-red-600">警察 110</div></div><div class="bg-red-50 p-4 rounded-2xl text-center cursor-pointer border border-red-100 hover:bg-red-100" @click="callNumber('119')"><i class="fas fa-ambulance text-3xl text-red-500 mb-2"></i><div class="font-bold text-red-600">救護 119</div></div></section>
                    </div>

                    <!-- 3. 購物 (圖片修復 & 點擊放大) -->
                    <div v-if="currentTab === 'shopping'" class="animate-fade-in">
                        <div class="grid grid-cols-2 gap-4">
                            <div v-for="(item, index) in shoppingList" :key="index" class="glass rounded-2xl overflow-hidden shadow-sm relative group cursor-pointer" @click="openZoom(item.image)">
                                <button @click.stop="triggerConfirm('確定移除此購物項目？', () => removeShoppingItem(index))" class="absolute top-2 right-2 bg-black/50 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 hover:bg-black/70 z-10"><i class="fas fa-times"></i></button>
                                <div class="h-32 w-full bg-gray-200 overflow-hidden flex items-center justify-center relative">
                                    <img v-if="item.image" :src="item.image" class="w-full h-full object-cover absolute inset-0">
                                    <div v-else class="text-gray-400 text-xs flex flex-col items-center"><i class="fas fa-image text-2xl mb-1"></i>No Image</div>
                                </div>
                                <div class="p-3"><h4 class="font-bold text-sm truncate text-black mb-1">{{ item.name }}</h4><div class="flex items-center justify-between mt-2"><div class="flex items-center"><input type="checkbox" v-model="item.checked" @click.stop class="w-4 h-4 rounded text-blue-500"><span class="text-xs text-gray-500 ml-1" :class="{'line-through': item.checked}">已買</span></div><div v-if="item.price" class="text-xs font-bold text-navy-800">¥ {{ Number(item.price).toLocaleString() }}</div></div></div>
                            </div>
                        </div>
                        <button @click="showShoppingModal = true" class="fixed bottom-6 right-6 w-14 h-14 bg-pink-500 text-white rounded-full shadow-2xl flex items-center justify-center text-2xl hover:scale-110 transition-transform z-40 border-2 border-white"><i class="fas fa-plus"></i></button>
                    </div>

                    <!-- 4. 開支 (圓餅圖) -->
                    <div v-if="currentTab === 'expenses'" class="animate-fade-in">
                        <div class="bg-navy-900 text-white rounded-2xl p-6 mb-6 shadow-xl relative overflow-hidden">
                            <div class="absolute -right-6 -top-6 w-32 h-32 bg-ice-500 rounded-full opacity-20 blur-2xl"></div>
                            <p class="text-sm opacity-70 mb-1">總支出 (日幣)</p>
                            <h2 class="text-4xl font-bold">¥ {{ totalExpenses.toLocaleString() }}</h2>
                            <p class="text-xs opacity-50 mt-2">約 HKD {{ (totalExpenses * currency.rate).toFixed(1) }}</p>
                            <!-- Pie Chart -->
                            <div class="mt-4 bg-white/10 rounded-xl p-2 flex justify-center" v-show="expenses.length > 0"><div class="w-48 h-48"><canvas ref="expenseChartCanvas"></canvas></div></div>
                        </div>
                        <div class="space-y-3">
                            <div v-for="(exp) in expenses" :key="exp.id" class="glass p-4 rounded-xl flex items-center justify-between">
                                <div class="flex items-center"><div :class="['w-10 h-10 rounded-full flex items-center justify-center text-white mr-3', getExpenseColor(exp.category)]"><i :class="getExpenseIcon(exp.category)"></i></div><div><h4 class="font-bold text-sm text-black">{{ exp.name }}</h4><p class="text-xs text-gray-500">{{ exp.date }} · {{ exp.method }}</p></div></div>
                                <div class="text-right"><div class="font-bold text-black">¥ {{ Number(exp.amount).toLocaleString() }}</div><button @click="triggerConfirm('確定刪除此筆開支紀錄？', () => removeExpense(exp.id))" class="text-[10px] text-red-400 mt-1 hover:text-red-600">刪除</button></div>
                            </div>
                        </div>
                        <button @click="showExpenseModal = true" class="fixed bottom-6 right-6 w-14 h-14 bg-yellow-500 text-white rounded-full shadow-2xl flex items-center justify-center text-2xl hover:scale-110 transition-transform z-40 border-2 border-white"><i class="fas fa-plus"></i></button>
                    </div>

                    <!-- 5. 日語 (Expanded 10 phrases per category) -->
                    <div v-if="currentTab === 'japanese'" class="animate-fade-in pb-10">
                        <div class="flex overflow-x-auto space-x-2 mb-4 no-scrollbar"><button v-for="cat in japaneseCategories" @click="currentJpCat = cat" :class="['px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap transition-colors border shadow-sm', currentJpCat === cat ? 'bg-navy-800 text-white border-transparent' : 'bg-white text-gray-500 border-gray-200']">{{ cat }}</button></div>
                        <div class="space-y-3">
                            <div v-for="(phrase, index) in filteredJapanese" :key="index" class="glass p-5 rounded-xl flex justify-between items-center hover:border-indigo-200 transition-colors">
                                <div><h3 class="font-bold text-lg text-black mb-1">{{ phrase.jp }}</h3><p class="text-sm text-gray-700">{{ phrase.zh }}</p><p class="text-xs text-gray-400 mt-1 italic">{{ phrase.romaji }}</p></div>
                                <button @click="speak(phrase.jp)" class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center active:scale-90 transition-transform hover:bg-blue-200"><i class="fas fa-volume-up"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Modals -->
        <div v-if="confirmState.show" class="fixed inset-0 z-[200] bg-black/60 backdrop-blur-sm flex items-center justify-center">
            <div class="bg-white w-[80%] max-w-sm p-6 rounded-3xl shadow-2xl animate-pop-in text-center border border-gray-100">
                 <div class="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl"><i class="fas fa-exclamation"></i></div>
                 <h3 class="text-xl font-bold mb-2 text-black">確認刪除？</h3>
                 <p class="text-sm text-gray-600 mb-8">{{ confirmState.msg }}</p>
                 <div class="flex space-x-3"><button @click="confirmState.show = false" class="flex-1 py-3 rounded-2xl bg-gray-100 font-bold text-gray-600 hover:bg-gray-200">取消</button><button @click="executeConfirm" class="flex-1 py-3 rounded-2xl bg-red-500 text-white font-bold shadow-lg shadow-red-500/30 hover:bg-red-600">刪除</button></div>
            </div>
        </div>
        <!-- Image Zoom (Lightbox) -->
        <div v-if="showImageZoom" class="fixed inset-0 z-[200] bg-black/90 flex items-center justify-center p-4 cursor-pointer animate-fade-in" @click="showImageZoom = false">
            <img v-if="zoomedImage" :src="zoomedImage" class="max-w-full max-h-full rounded-lg shadow-2xl transform transition-transform scale-100 hover:scale-105">
            <div v-else class="text-white text-xl">沒有圖片</div>
            <button class="absolute top-4 right-4 text-white text-3xl hover:text-gray-300"><i class="fas fa-times"></i></button>
        </div>
        
        <div v-if="showAddModal" class="fixed inset-0 z-[100] bg-black/50 backdrop-blur-sm flex items-end md:items-center justify-center"><div class="bg-white w-full md:w-[500px] rounded-t-3xl p-6 shadow-2xl animate-slide-up max-h-[90vh] overflow-y-auto"><div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-black">{{ isEditing ? '編輯行程' : '新增行程' }}</h3><button @click="showAddModal = false" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button></div><div class="space-y-4"><div><label class="text-xs text-gray-500 mb-1 block">分類</label><select v-model="form.category" class="w-full bg-gray-50 p-3 rounded-xl outline-none text-black border border-gray-200"><option value="sightseeing">景點</option><option value="food">美食</option><option value="shopping">購物</option><option value="hotel">住宿</option><option value="flight">航班</option><option value="other">其他</option></select></div><div><label class="text-xs text-gray-500 mb-1 block">名稱</label><input v-model="form.name" class="w-full bg-gray-50 p-3 rounded-xl outline-none text-black border border-gray-200"></div><div><label class="text-xs text-gray-500 mb-1 block">開始時間</label><input type="time" v-model="form.startTime" class="w-full bg-gray-50 p-3 rounded-xl outline-none text-black border border-gray-200"></div><div v-if="form.category === 'flight'" class="grid grid-cols-2 gap-3 bg-gray-50 p-3 rounded-xl border border-gray-200"><input v-model="form.flightCode" placeholder="航班編號" class="p-2 rounded bg-white w-full border border-gray-200 text-black"><input v-model="form.duration" placeholder="飛行時間" class="p-2 rounded bg-white w-full border border-gray-200 text-black"><input v-model="form.depAirport" placeholder="起飛" class="p-2 rounded bg-white w-full border border-gray-200 text-black"><input v-model="form.depTime" type="time" class="p-2 rounded bg-white w-full border border-gray-200 text-black"><input v-model="form.arrAirport" placeholder="抵達" class="p-2 rounded bg-white w-full border border-gray-200 text-black"><input v-model="form.arrTime" type="time" class="p-2 rounded bg-white w-full border border-gray-200 text-black"></div><div v-else class="grid grid-cols-2 gap-3"><div><label class="text-xs text-gray-500 mb-1 block">營業時間</label><input v-model="form.openTime" class="w-full bg-gray-50 p-3 rounded-xl outline-none border border-gray-200"></div><div><label class="text-xs text-gray-500 mb-1 block">門票</label><input v-model="form.ticketPrice" class="w-full bg-gray-50 p-3 rounded-xl outline-none border border-gray-200"></div></div><div><label class="text-xs text-gray-500 mb-1 block">交通</label><div class="flex space-x-2"><button v-for="m in ['walk','train','car']" @click="form.transportMode = m" :class="['flex-1 py-2 rounded-lg text-sm border', form.transportMode === m ? 'bg-navy-800 text-white' : 'bg-gray-50']"><i :class="getTransportIcon(m)"></i></button></div></div><div><label class="text-xs text-gray-500 mb-1 block">備註</label><textarea v-model="form.note" class="w-full bg-gray-50 p-3 rounded-xl outline-none border border-gray-200 h-20"></textarea></div><div class="flex space-x-3 pt-4"><button v-if="isEditing" @click="triggerConfirm('刪除此行程？', confirmDeleteItineraryItem)" class="flex-1 bg-red-50 text-red-500 py-3 rounded-xl font-bold border border-red-100">刪除</button><button @click="saveItinerary" class="flex-[2] bg-navy-900 text-white py-3 rounded-xl font-bold shadow-lg">儲存</button></div></div></div></div>
        
        <div v-if="showShoppingModal" class="fixed inset-0 z-[100] bg-black/50 backdrop-blur-sm flex items-end md:items-center justify-center">
            <div class="bg-white w-full md:w-[400px] rounded-t-3xl p-6 shadow-2xl animate-slide-up">
                <h3 class="text-xl font-bold mb-4">新增購物清單</h3>
                <input v-model="shoppingForm.name" placeholder="商品名稱" class="w-full bg-gray-50 p-3 rounded-xl mb-3 outline-none border border-gray-200">
                <input type="number" v-model="shoppingForm.price" placeholder="預算/金額 (日幣)" class="w-full bg-gray-50 p-3 rounded-xl mb-3 outline-none border border-gray-200">
                <label class="block w-full h-32 border-2 border-dashed border-gray-300 rounded-xl flex flex-col items-center justify-center cursor-pointer mb-4 hover:bg-gray-50"><span v-if="!shoppingForm.preview" class="text-gray-400 text-sm"><i class="fas fa-camera mb-2"></i> 上傳圖片</span><img v-else :src="shoppingForm.preview" class="h-full w-full object-cover rounded-xl"><input type="file" accept="image/*" class="hidden" @change="handleImageUpload"></label>
                <button @click="saveShopping" class="w-full bg-pink-500 text-white py-3 rounded-xl font-bold shadow-md">加入清單</button>
                <button @click="showShoppingModal = false" class="w-full text-gray-500 py-2 mt-2 text-sm text-center block">取消</button>
            </div>
        </div>

        <div v-if="showExpenseModal" class="fixed inset-0 z-[100] bg-black/50 backdrop-blur-sm flex items-end md:items-center justify-center">
            <div class="bg-white w-full md:w-[400px] rounded-t-3xl p-6 shadow-2xl animate-slide-up">
                <h3 class="text-xl font-bold mb-4">記帳</h3>
                <div class="grid grid-cols-3 gap-2 mb-4"><button v-for="cat in ['交通','飲食','住宿','門票','購物','其他']" @click="expenseForm.category = cat" :class="['text-xs py-2 rounded-lg border', expenseForm.category === cat ? 'bg-navy-900 text-white' : 'text-gray-600']">{{ cat }}</button></div>
                <input v-model="expenseForm.name" placeholder="項目名稱" class="w-full bg-gray-50 p-3 rounded-xl mb-3 outline-none border border-gray-200">
                <input type="number" v-model="expenseForm.amount" placeholder="金額 (日幣)" class="w-full bg-gray-50 p-3 rounded-xl mb-3 outline-none border border-gray-200">
                <div class="flex space-x-2 mb-4"><button @click="expenseForm.method = '現金'" :class="['flex-1 py-2 rounded-lg text-sm border', expenseForm.method === '現金' ? 'bg-green-500 text-white' : 'bg-gray-50']">現金</button><button @click="expenseForm.method = '信用卡'" :class="['flex-1 py-2 rounded-lg text-sm border', expenseForm.method === '信用卡' ? 'bg-blue-500 text-white' : 'bg-gray-50']">信用卡</button></div>
                <button @click="saveExpense" class="w-full bg-navy-900 text-white py-3 rounded-xl font-bold shadow-md">儲存</button>
                <button @click="showExpenseModal = false" class="w-full text-gray-500 py-2 mt-2 text-sm text-center block">取消</button>
            </div>
        </div>

        <div v-if="showInfoModal" class="fixed inset-0 z-[100] bg-black/50 backdrop-blur-sm flex items-end md:items-center justify-center"><div class="bg-white w-full md:w-[500px] rounded-t-3xl p-6 shadow-2xl animate-slide-up"><div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-black">{{ infoMode === 'add' ? '新增' : '編輯' }}資訊</h3><button @click="showInfoModal = false" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button></div><div class="space-y-4"><div v-if="infoType === 'flight'" class="space-y-3"><div class="flex space-x-3"><input v-model="infoForm.title" placeholder="標題" class="flex-1 p-3 rounded-xl bg-gray-50 border outline-none"><input v-model="infoForm.date" type="date" class="flex-1 p-3 rounded-xl bg-gray-50 border outline-none"></div><input v-model="infoForm.code" placeholder="航班" class="w-full p-3 rounded-xl bg-gray-50 border outline-none"><div class="grid grid-cols-2 gap-3 bg-gray-50 p-3 rounded-xl border"><input v-model="infoForm.depCode" placeholder="起飛" class="p-2 rounded border w-full"><input v-model="infoForm.depTime" type="time" class="p-2 rounded border w-full"><input v-model="infoForm.arrCode" placeholder="抵達" class="p-2 rounded border w-full"><input v-model="infoForm.arrTime" type="time" class="p-2 rounded border w-full"></div><input v-model="infoForm.duration" placeholder="時長" class="w-full p-3 rounded-xl bg-gray-50 border outline-none"></div><div v-if="infoType === 'hotel'" class="space-y-3"><input v-model="infoForm.name" placeholder="飯店" class="w-full p-3 rounded-xl bg-gray-50 border outline-none"><input v-model="infoForm.address" placeholder="地址" class="w-full p-3 rounded-xl bg-gray-50 border outline-none"><input v-model="infoForm.phone" placeholder="電話" class="w-full p-3 rounded-xl bg-gray-50 border outline-none"></div><button @click="saveInfoData" class="w-full bg-navy-900 text-white py-3 rounded-xl font-bold mt-4 shadow-md">儲存</button></div></div></div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { createApp, ref, computed, watch, onMounted, nextTick } from "https://unpkg.com/vue@3/dist/vue.esm-browser.js";

        // ==========================================================================================
        // [GitHub 部署設定]
        // ==========================================================================================
        const userFirebaseConfig = {
            apiKey: "AIzaSyArAk6Y3h38j8YzagbyOTWwtpN1Mh5xNiw",
                authDomain: "travel-box-62d35.firebaseapp.com",
            projectId: "travel-box-62d35",
            storageBucket: "travel-box-62d35.firebasestorage.app",
            messagingSenderId: "133527202914",
            appId: "1:133527202914:web:d13cd249fead572ec7b53b"
        };
        
        let firebaseConfig;
        try {
            if (typeof __firebase_config !== 'undefined') {
                firebaseConfig = JSON.parse(__firebase_config);
            } else {
                firebaseConfig = userFirebaseConfig;
            }
        } catch (e) {
            firebaseConfig = userFirebaseConfig;
        }

        const APP_ID = 'my-2026-fukuoka-trip';
        // ==========================================================================================

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const currentAppId = (typeof __app_id !== 'undefined') ? __app_id : APP_ID;

        createApp({
            setup() {
                // State
                const currentTab = ref('itinerary');
                const selectedDateIndex = ref(0);
                const showAddModal = ref(false), showShoppingModal = ref(false), showExpenseModal = ref(false), showInfoModal = ref(false);
                const isEditing = ref(false);
                const infoMode = ref('add'), infoType = ref('flight');
                const loading = ref(true);
                const zoomedImage = ref(null), showImageZoom = ref(false);
                const expenseChartCanvas = ref(null);
                let expenseChart = null;
                const confirmState = ref({ show: false, msg: '', action: null });
                
                // Data
                const tripDates = ref([
                    { fullDate: '2026-01-02', week: 'Fri', date: '2' }, { fullDate: '2026-01-03', week: 'Sat', date: '3' },
                    { fullDate: '2026-01-04', week: 'Sun', date: '4' }, { fullDate: '2026-01-05', week: 'Mon', date: '5' },
                    { fullDate: '2026-01-06', week: 'Tue', date: '6' }, { fullDate: '2026-01-07', week: 'Wed', date: '7' }
                ]);
                const currency = ref({ rate: 0.05, jpy: 0, hkd: 0 });
                const weather = ref({ temp: 8, feelsLike: 5, status: '晴時多雲', icon: 'fas fa-cloud-sun', isForecast: false });
                const itineraryData = ref({ '2026-01-02': [], '2026-01-03': [], '2026-01-04': [], '2026-01-05': [], '2026-01-06': [], '2026-01-07': [] });
                const flights = ref([]), hotels = ref([]), shoppingList = ref([]), expenses = ref([]);
                
                // Forms
                const infoForm = ref({});
                const shoppingForm = ref({ name: '', price: '', preview: null });
                const expenseForm = ref({ id: null, category: '飲食', name: '', amount: '', method: '現金', date: '' });
                const form = ref({ id: null, category: 'sightseeing', startTime: '', name: '', openTime: '', ticketPrice: '', note: '', transportMode: 'train' });

                // Expanded Japanese Data (10 per category)
                const japaneseData = [
                    // Basic
                    { cat: '基本應對', jp: 'こんにちは', romaji: 'Konnichiwa', zh: '你好' }, { cat: '基本應對', jp: 'ありがとうございます', romaji: 'Arigatou', zh: '謝謝' },
                    { cat: '基本應對', jp: 'すみません', romaji: 'Sumimasen', zh: '不好意思' }, { cat: '基本應對', jp: 'はい / いいえ', romaji: 'Hai / Iie', zh: '是 / 不是' },
                    { cat: '基本應對', jp: 'おはようございます', romaji: 'Ohayou', zh: '早安' }, { cat: '基本應對', jp: 'こんばんは', romaji: 'Konbanwa', zh: '晚安' },
                    { cat: '基本應對', jp: 'さようなら', romaji: 'Sayounara', zh: '再見' }, { cat: '基本應對', jp: 'わかりません', romaji: 'Wakarimasen', zh: '我不明白' },
                    { cat: '基本應對', jp: '英語は話せますか？', romaji: 'Eigo?', zh: '會說英文嗎？' }, { cat: '基本應對', jp: '大丈夫です', romaji: 'Daijoubu', zh: '沒關係/不用了' },
                    // Shopping
                    { cat: '購物結帳', jp: 'いくらですか？', romaji: 'Ikura?', zh: '多少錢？' }, { cat: '購物結帳', jp: '免税できますか？', romaji: 'Menzei?', zh: '免稅嗎？' },
                    { cat: '購物結帳', jp: 'クレジットカード', romaji: 'Kurejitto?', zh: '信用卡？' }, { cat: '購物結帳', jp: '袋をください', romaji: 'Fukuro kudasai', zh: '請給袋子' },
                    { cat: '購物結帳', jp: 'これをください', romaji: 'Kore kudasai', zh: '我要這個' }, { cat: '購物結帳', jp: '試着できますか？', romaji: 'Shichaku?', zh: '可以試穿嗎？' },
                    { cat: '購物結帳', jp: 'レシートください', romaji: 'Reshiito', zh: '請給收據' }, { cat: '購物結帳', jp: '違う色はありますか', romaji: 'Chigau iro?', zh: '有別的顏色嗎' },
                    { cat: '購物結帳', jp: 'プレゼント用です', romaji: 'Purezento', zh: '這是禮物' }, { cat: '購物結帳', jp: '見ているだけです', romaji: 'Miteiru dake', zh: '只是看看' },
                    // Restaurant
                    { cat: '餐廳點餐', jp: 'メニューください', romaji: 'Menyu', zh: '菜單' }, { cat: '餐廳點餐', jp: 'お水ください', romaji: 'Omizu', zh: '請給水' },
                    { cat: '餐廳點餐', jp: '注文お願いします', romaji: 'Chuumon', zh: '點餐' }, { cat: '餐廳點餐', jp: 'おすすめは？', romaji: 'Osusume?', zh: '推薦什麼？' },
                    { cat: '餐廳點餐', jp: 'お会計', romaji: 'Okaikei', zh: '結帳' }, { cat: '餐廳點餐', jp: 'ごちそうさま', romaji: 'Gochisousama', zh: '多謝款待' },
                    { cat: '餐廳點餐', jp: '乾杯', romaji: 'Kanpai', zh: '乾杯' }, { cat: '餐廳點餐', jp: 'おかわり', romaji: 'Okawari', zh: '再來一份/續杯' },
                    { cat: '餐廳點餐', jp: '禁煙席', romaji: 'Kinen seki', zh: '禁菸席' }, { cat: '餐廳點餐', jp: '辛いですか？', romaji: 'Karai?', zh: '會辣嗎？' },
                    // Transport
                    { cat: '交通問路', jp: '駅はどこですか？', romaji: 'Eki wa doko?', zh: '車站在哪？' }, { cat: '交通問路', jp: '博多に行きますか？', romaji: 'Hakata ni ikimasu ka?', zh: '去博多嗎？' },
                    { cat: '交通問路', jp: 'ここに行きたい', romaji: 'Koko ni ikitai', zh: '想去這裡' }, { cat: '交通問路', jp: '切符売り場', romaji: 'Kippu uriba', zh: '售票處' },
                    { cat: '交通問路', jp: 'タクシー乗り場', romaji: 'Takushii noriba', zh: '計程車招呼站' }, { cat: '交通問路', jp: 'トイレ', romaji: 'Toire', zh: '廁所' },
                    { cat: '交通問路', jp: '何番線ですか？', romaji: 'Nan ban sen?', zh: '幾號月台？' }, { cat: '交通問路', jp: 'ここで降ります', romaji: 'Koko de orimasu', zh: '這裡下車' },
                    { cat: '交通問路', jp: 'どのくらいかかりますか', romaji: 'Donokurai?', zh: '要多久？' }, { cat: '交通問路', jp: '路線図', romaji: 'Rosenzu', zh: '路線圖' },
                    // Emergency
                    { cat: '緊急狀況', jp: '助けて', romaji: 'Tasukete', zh: '救命' }, { cat: '緊急狀況', jp: 'パスポートなくした', romaji: 'Pasupooto nakushita', zh: '護照不見了' },
                    { cat: '緊急狀況', jp: '具合が悪いです', romaji: 'Guai ga warui', zh: '我不舒服' }, { cat: '緊急狀況', jp: '警察', romaji: 'Keisatsu', zh: '警察' },
                    { cat: '緊急狀況', jp: '救急車', romaji: 'Kyuukyuusha', zh: '救護車' }, { cat: '緊急狀況', jp: '迷子です', romaji: 'Maigo desu', zh: '迷路了' },
                    { cat: '緊急狀況', jp: 'お腹が痛い', romaji: 'Onaka itai', zh: '肚子痛' }, { cat: '緊急狀況', jp: '熱があります', romaji: 'Netsu ga aru', zh: '發燒了' },
                    { cat: '緊急狀況', jp: '財布を盗まれた', romaji: 'Saifu nusumareta', zh: '錢包被偷了' }, { cat: '緊急狀況', jp: '大使館', romaji: 'Taishikan', zh: '大使館' },
                ];
                const currentJpCat = ref('基本應對');
                const japaneseCategories = ['基本應對', '購物結帳', '餐廳點餐', '交通問路', '緊急狀況'];
                const tabs = [{id:'itinerary',name:'行程',icon:'fas fa-map-marked-alt'},{id:'info',name:'資訊',icon:'fas fa-info-circle'},{id:'shopping',name:'購物',icon:'fas fa-shopping-basket'},{id:'expenses',name:'開支',icon:'fas fa-yen-sign'},{id:'japanese',name:'日語',icon:'fas fa-language'}];

                // Computed
                const currentKey = computed(() => tripDates.value[selectedDateIndex.value]?.fullDate || '');
                const currentDayItinerary = computed(() => itineraryData.value[currentKey.value] || []);
                const totalExpenses = computed(() => expenses.value.reduce((sum, item) => sum + Number(item.amount), 0));
                const filteredJapanese = computed(() => japaneseData.filter(i => i.cat === currentJpCat.value));

                // Helpers
                const triggerConfirm = (msg, action) => { confirmState.value = { show: true, msg, action }; };
                const executeConfirm = () => { 
                    if(confirmState.value.action) confirmState.value.action(); 
                    confirmState.value.show = false; 
                    // Close parent modals if any
                    if(showAddModal.value) showAddModal.value = false;
                };
                const openMap = (k) => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(k)}`, '_blank');
                const calculateTravelTime = (p, c) => c.transportMode==='walk'?'15 分':c.transportMode==='car'?'25 分':'10 分';
                const speak = (t) => { const u=new SpeechSynthesisUtterance(t); u.lang='ja-JP'; window.speechSynthesis.speak(u); };
                const callNumber = (n) => window.location.href=`tel:${n}`;
                
                const getCategoryName = (c) => ({sightseeing:'景點',food:'美食',shopping:'購物',hotel:'住宿',flight:'航班',other:'其他'}[c]||'其他');
                const getCategoryColor = (c) => ({sightseeing:'bg-green-500',food:'bg-orange-400',shopping:'bg-pink-500',hotel:'bg-indigo-500',flight:'bg-blue-600',other:'bg-gray-500'}[c]);
                const getCategoryIcon = (c) => ({sightseeing:'fas fa-camera',food:'fas fa-utensils',shopping:'fas fa-shopping-bag',hotel:'fas fa-bed',flight:'fas fa-plane',other:'fas fa-map-marker-alt'}[c]);
                const getTransportIcon = (m) => m==='walk'?'fas fa-walking':m==='car'?'fas fa-car':'fas fa-subway';
                const getExpenseIcon = (c) => ({'交通':'fas fa-train','飲食':'fas fa-utensils','住宿':'fas fa-bed','門票':'fas fa-ticket-alt','購物':'fas fa-shopping-bag','其他':'fas fa-circle'}[c]);
                const getExpenseColor = (c) => ({'交通':'bg-blue-400','飲食':'bg-orange-400','住宿':'bg-indigo-400','門票':'bg-green-400','購物':'bg-pink-400','其他':'bg-gray-400'}[c]);

                // Logic
                const addDay = () => { /* Same add day logic */ };
                const deleteDay = (idx) => { if(tripDates.value.length>1){ if(idx===selectedDateIndex.value)selectedDateIndex.value=0; else if(idx<selectedDateIndex.value)selectedDateIndex.value--; tripDates.value.splice(idx,1); saveData(); }};
                const dragStart = (idx) => { event.dataTransfer.effectAllowed = 'move'; event.dataTransfer.setData('text/plain', idx); };
                const drop = (toIdx) => { const fromIdx = event.dataTransfer.getData('text/plain'); if(fromIdx!=='') { const list = itineraryData.value[currentKey.value]; const [m] = list.splice(fromIdx, 1); list.splice(toIdx, 0, m); saveData(); }};
                const moveItem = (idx, dir) => { const list = itineraryData.value[currentKey.value]; const n = idx+dir; if(n>=0 && n<list.length){ [list[idx],list[n]]=[list[n],list[idx]]; saveData(); }};

                const resetForm = () => { form.value = { id: null, category: 'sightseeing', startTime: '', name: '', openTime: '', ticketPrice: '', note: '', transportMode: 'train', flightCode: '', duration: '', depAirport: '', depTime: '', arrAirport: '', arrTime: '' }; };
                const saveItinerary = () => { const list = itineraryData.value[currentKey.value]; if(isEditing.value){const i=list.findIndex(x=>x.id===form.value.id);if(i!==-1)list[i]={...form.value};}else{form.value.id=Date.now();list.push({...form.value});} saveData(); showAddModal.value=false; };
                const editItem = (item) => { form.value={...item}; isEditing.value=true; showAddModal.value=true; };
                const confirmDeleteItineraryItem = () => { const list=itineraryData.value[currentKey.value]; const i=list.findIndex(x=>x.id===form.value.id); if(i!==-1)list.splice(i,1); saveData(); }; // Parent modal closes in executeConfirm

                const openInfoModal = (t, m, d=null) => { infoType.value=t; infoMode.value=m; infoForm.value=m==='edit'&&d?{...d}:{id:null}; showInfoModal.value=true; };
                const saveInfoData = () => { if(infoType.value==='flight'){if(infoMode.value==='add')flights.value.push({...infoForm.value,id:Date.now()});else{const i=flights.value.findIndex(x=>x.id===infoForm.value.id);if(i!==-1)flights.value[i]={...infoForm.value};}}else{if(infoMode.value==='add')hotels.value.push({...infoForm.value,id:Date.now()});else{const i=hotels.value.findIndex(x=>x.id===infoForm.value.id);if(i!==-1)hotels.value[i]={...infoForm.value};}} saveData(); showInfoModal.value=false; };
                const deleteInfoData = (t, id) => { if(t==='flight'){const i=flights.value.findIndex(x=>x.id===id);if(i!==-1)flights.value.splice(i,1);}else{const i=hotels.value.findIndex(x=>x.id===id);if(i!==-1)hotels.value.splice(i,1);} saveData(); };

                const updateExchangeRate = async () => { try { const res = await fetch('https://open.er-api.com/v6/latest/HKD'); const data = await res.json(); if(data?.rates?.JPY) currency.value.rate = (1/data.rates.JPY).toFixed(4); } catch(e){} };
                const convertCurrency = (t) => { if(t==='jpy') currency.value.hkd=(currency.value.jpy*currency.value.rate).toFixed(2); else currency.value.jpy=(currency.value.hkd/currency.value.rate).toFixed(0); };
                
                const handleImageUpload = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            const maxWidth = 800; const maxHeight = 800;
                            let width = img.width; let height = img.height;
                            if (width > height) { if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; } } 
                            else { if (height > maxHeight) { width *= maxHeight / height; height = maxHeight; } }
                            canvas.width = width; canvas.height = height;
                            ctx.drawImage(img, 0, 0, width, height);
                            shoppingForm.value.preview = canvas.toDataURL('image/jpeg', 0.7);
                        };
                        img.src = event.target.result;
                    };
                    reader.readAsDataURL(file);
                };
                const saveShopping = () => { if(!shoppingForm.value.name)return; shoppingList.value.push({...shoppingForm.value, id:Date.now(), checked:false}); shoppingForm.value={name:'',price:'',preview:null}; showShoppingModal.value=false; saveData(); };
                const removeShoppingItem = (i) => { shoppingList.value.splice(i,1); saveData(); };
                const openZoom = (img) => { 
                    zoomedImage.value = img || 'https://via.placeholder.com/150?text=No+Image'; 
                    showImageZoom.value = true; 
                };
                
                const updateChart = () => {
                    if(!expenseChartCanvas.value) return;
                    const cats = ['交通','飲食','住宿','門票','購物','其他'];
                    const data = cats.map(c => expenses.value.filter(e => e.category===c).reduce((s,e)=>s+Number(e.amount),0));
                    if(expenseChart) expenseChart.destroy();
                    expenseChart = new Chart(expenseChartCanvas.value.getContext('2d'), { type:'doughnut', data: { labels: cats, datasets: [{ data, backgroundColor: ['#60A5FA','#FB923C','#818CF8','#4ADE80','#F472B6','#94A3B8'], borderWidth:0 }] }, options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} } });
                };
                const saveExpense = () => { if(!expenseForm.value.name)return; expenses.value.push({...expenseForm.value, id:Date.now(), date:currentKey.value}); expenseForm.value={id:null,category:'飲食',name:'',amount:'',method:'現金',date:''}; showExpenseModal.value=false; saveData(); nextTick(updateChart); };
                const removeExpense = (id) => { const i=expenses.value.findIndex(e=>e.id===id); if(i!==-1)expenses.value.splice(i,1); saveData(); nextTick(updateChart); };
                watch(currentTab, (v) => { if(v==='expenses') nextTick(updateChart); });

                const fetchWeather = async () => {
                   const lat = 33.5904; const lon = 130.4017; const dateStr = currentKey.value;
                   try {
                       const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&timezone=Asia%2FTokyo`);
                       const data = await res.json();
                       if(data.current_weather) weather.value = { temp: Math.round(data.current_weather.temperature), feelsLike: Math.round(data.current_weather.temperature), status: '即時', icon: 'fas fa-sun', isForecast: false };
                   } catch(e) {}
                };
                watch(selectedDateIndex, fetchWeather);

                const saveData = () => {
                    const data = {
                        tripDates: JSON.stringify(tripDates.value),
                        itinerary: JSON.stringify(itineraryData.value),
                        shopping: JSON.stringify(shoppingList.value),
                        expenses: JSON.stringify(expenses.value),
                        flights: JSON.stringify(flights.value),
                        hotels: JSON.stringify(hotels.value)
                    };
                    setDoc(doc(db, 'artifacts', currentAppId, 'public', 'data', 'travel', 'main'), data).catch(e=>{});
                };

                onMounted(() => {
                    const authPromise = (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) ? signInWithCustomToken(auth, __initial_auth_token) : signInAnonymously(auth);
                    authPromise.then(() => {
                        onSnapshot(doc(db, 'artifacts', currentAppId, 'public', 'data', 'travel', 'main'), (snap) => {
                            if(snap.exists()) {
                                const d = snap.data();
                                if (d.tripDates) tripDates.value = JSON.parse(d.tripDates);
                                if (d.itinerary) Object.assign(itineraryData.value, JSON.parse(d.itinerary));
                                if (d.shopping) shoppingList.value = JSON.parse(d.shopping);
                                if (d.expenses) expenses.value = JSON.parse(d.expenses);
                                if (d.flights) flights.value = JSON.parse(d.flights);
                                if (d.hotels) hotels.value = JSON.parse(d.hotels);
                            } else { saveData(); }
                            loading.value = false;
                        });
                    });
                    updateExchangeRate();
                    fetchWeather();
                });

                return { currentTab, tabs, tripDates, selectedDateIndex, weather, currency, currentDayItinerary, showAddModal, isEditing, form, saveItinerary, editItem, confirmDeleteItineraryItem, resetForm, dragStart, drop, addDay, deleteDay, openMap, calculateTravelTime, moveItem, shoppingList, showShoppingModal, shoppingForm, handleImageUpload, saveShopping, removeShoppingItem, expenses, showExpenseModal, expenseForm, saveExpense, removeExpense, totalExpenses, japaneseCategories, currentJpCat, filteredJapanese, speak, callNumber, convertCurrency, flights, hotels, showInfoModal, infoMode, infoType, infoForm, openInfoModal, saveInfoData, deleteInfoData, confirmState, triggerConfirm, executeConfirm, loading, zoomedImage, showImageZoom, openZoom, expenseChartCanvas, getCategoryName, getCategoryColor, getCategoryIcon, getTransportIcon, getExpenseIcon, getExpenseColor };
            }
        }).mount('#app');
    </script>
</body>
</html>